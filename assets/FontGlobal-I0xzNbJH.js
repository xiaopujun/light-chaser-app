var p=Object.defineProperty;var g=(t,e,s)=>e in t?p(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var i=(t,e,s)=>(g(t,typeof e!="symbol"?e+"":e,s),s);import{R as React,j as jsxRuntimeExports,r as reactExports,L as Loading}from"./index-OsS9UfkW.js";import{j as layerListStore,l as layerManager,o as AnchorPointType,k as bluePrintManager,D as DesignerLoaderFactory,q as AbstractController,e as eventOperateStore}from"./LayerManager-yWnDoBOm.js";import{m as makeObservable,a as observable,b as action}from"./mobxreact.esm-rNVktGB7.js";import{E as Edit,P as PreviewOpen}from"./PreviewOpen-nQ2Iv4_U.js";import{I as IconWrapper}from"./index-K2O65-hP.js";import{l as lodashExports}from"./ObjectUtil-nMvTrJhh.js";import{U as URLUtil,D as DesignerMode}from"./LocalOperator-BbYzoZ36.js";import{F as FetchUtil}from"./FetchUtil-Ivd_z0Im.js";const FolderClose=IconWrapper("folder-close",!0,function(t){return React.createElement("svg",{width:t.size,height:t.size,viewBox:"0 0 48 48",fill:"none"},React.createElement("path",{d:"M5 8C5 6.89543 5.89543 6 7 6H19L24 12H41C42.1046 12 43 12.8954 43 14V40C43 41.1046 42.1046 42 41 42H7C5.89543 42 5 41.1046 5 40V8Z",fill:t.colors[1],stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M43 22H5",stroke:t.colors[2],strokeWidth:t.strokeWidth,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M5 16V28",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M43 16V28",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}))}),Lock=IconWrapper("lock",!1,function(t){return React.createElement("svg",{width:t.size,height:t.size,viewBox:"0 0 48 48",fill:"none"},React.createElement("rect",{x:"6",y:"22",width:"36",height:"22",rx:"2",fill:t.colors[1],stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M14 22V14C14 8.47715 18.4772 4 24 4C29.5228 4 34 8.47715 34 14V22",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M24 30V36",stroke:t.colors[2],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}))}),PreviewClose=IconWrapper("preview-close",!1,function(t){return React.createElement("svg",{width:t.size,height:t.size,viewBox:"0 0 48 48",fill:"none"},React.createElement("path",{d:"M6 16C6.63472 17.2193 7.59646 18.3504 8.82276 19.3554C12.261 22.1733 17.779 24 24 24C30.221 24 35.739 22.1733 39.1772 19.3554C40.4035 18.3504 41.3653 17.2193 42 16",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M28.9775 24L31.048 31.7274",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M37.3535 21.3536L43.0103 27.0104",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M5.00004 27.0103L10.6569 21.3534",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M16.9278 31.7276L18.9983 24.0001",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}))}),Unlock=IconWrapper("unlock",!0,function(t){return React.createElement("svg",{width:t.size,height:t.size,viewBox:"0 0 48 48",fill:"none"},React.createElement("rect",{x:"7",y:"22.0476",width:"34",height:"22",rx:"2",fill:t.colors[1],stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M14 22V14.0047C13.9948 8.87022 17.9227 4.56718 23.0859 4.05117C28.249 3.53516 32.9673 6.97408 34 12.0059",stroke:t.colors[0],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}),React.createElement("path",{d:"M24 30V36",stroke:t.colors[2],strokeWidth:t.strokeWidth,strokeLinecap:t.strokeLinecap,strokeLinejoin:t.strokeLinejoin}))});class CanvasContextMenuStore{constructor(){i(this,"visible",!1);i(this,"position",[0,0]);i(this,"mouseDownTime",0);i(this,"mouseUpTime",0);i(this,"updateVisible",e=>this.visible=e);i(this,"setPosition",e=>this.position=e);i(this,"setMouseDownTime",e=>this.mouseDownTime=e);i(this,"setMouseUpTime",e=>this.mouseUpTime=e);makeObservable(this,{visible:observable,position:observable,updateVisible:action,setPosition:action})}}const contextMenuStore=new CanvasContextMenuStore;class BaseLayer extends React.PureComponent{constructor(s){super(s);i(this,"layerName","");i(this,"closeContextMenu",()=>{const{visible:s,updateVisible:o}=contextMenuStore;s&&o(!1)});i(this,"toggleLock",s=>{s.stopPropagation();const{lockChange:o}=layerListStore;o&&o(this.state.compId,!this.state.lock),this.closeContextMenu()});i(this,"toggleHide",s=>{s.stopPropagation();const{hideChange:o}=layerListStore;o&&o(this.state.compId,!this.state.hide),this.closeContextMenu()});i(this,"onSelected",s=>{const{hide:o,compId:n}=this.state;if(o)return;s.stopPropagation();const{selectedChange:r}=layerListStore;r&&r(n,s),this.closeContextMenu()});i(this,"openInput",s=>{s.stopPropagation();const{inputMode:o}=this.state;o||this.setState({inputMode:!0}),this.closeContextMenu()});i(this,"closeInput",()=>{const{inputMode:s,compId:o,name:n}=this.state;if(s&&n!==this.layerName){const{updateLayer:r,compController:c}=layerManager;r([{id:o,name:this.layerName}],!1);const a=c[o];a&&a.update({base:{name:this.layerName}},{reRender:!1}),this.setState({inputMode:!1,name:this.layerName})}else this.setState({inputMode:!1})});i(this,"changeLayerName",s=>{this.layerName=s.target.value});this.state={...s},this.layerName=s.name||""}}class LayerItem extends BaseLayer{render(){const{name:e="",inputMode:s,lock:o=!1,hide:n=!1,selected:r=!1}=this.state||{};return jsxRuntimeExports.jsxs("div",{className:`layer-item ${r?"layer-selected":n?"layer-hide":o?"layer-lock":""}`,onClick:this.onSelected,onDoubleClick:this.openInput,children:[jsxRuntimeExports.jsx("div",{className:"layer-name",children:s?jsxRuntimeExports.jsx("input",{type:"text",defaultValue:e,autoFocus:!0,onChange:this.changeLayerName,ref:c=>c==null?void 0:c.select(),onKeyDown:c=>{c.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):e}),jsxRuntimeExports.jsxs("div",{className:"layer-operators",children:[jsxRuntimeExports.jsx("div",{className:"layer-operator",onClick:this.openInput,children:jsxRuntimeExports.jsx(Edit,{})}),jsxRuntimeExports.jsx("div",{className:"layer-operator",onClick:this.toggleHide,children:n?jsxRuntimeExports.jsx(PreviewClose,{}):jsxRuntimeExports.jsx(PreviewOpen,{})}),jsxRuntimeExports.jsx("div",{className:"layer-operator",onClick:this.toggleLock,children:o?jsxRuntimeExports.jsx(Lock,{}):jsxRuntimeExports.jsx(Unlock,{})})]})]})}}class LayerGroupItem extends BaseLayer{render(){const{children:e}=this.props,{hide:s,lock:o,showContent:n,selected:r,name:c,inputMode:a}=this.state;return jsxRuntimeExports.jsxs("div",{className:"layer-group",children:[jsxRuntimeExports.jsxs("div",{className:`group-header ${r?"layer-selected":s?"layer-hide":o?"layer-lock":""}`,onDoubleClick:this.openInput,onClick:l=>this.onSelected(l),children:[jsxRuntimeExports.jsxs("div",{className:"group-left",children:[jsxRuntimeExports.jsx("div",{className:"group-icon",onClick:()=>this.setState({showContent:!n}),children:jsxRuntimeExports.jsx(FolderClose,{size:12})}),jsxRuntimeExports.jsx("div",{className:"group-name",children:a?jsxRuntimeExports.jsx("input",{type:"text",defaultValue:c,autoFocus:!0,onChange:this.changeLayerName,ref:l=>l==null?void 0:l.select(),onKeyDown:l=>{l.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):c})]}),jsxRuntimeExports.jsxs("div",{className:"group-operators",children:[jsxRuntimeExports.jsx("div",{className:"group-operator",onClick:this.openInput,children:jsxRuntimeExports.jsx(Edit,{})}),jsxRuntimeExports.jsx("div",{className:"group-operator",onClick:this.toggleHide,children:s?jsxRuntimeExports.jsx(PreviewClose,{}):jsxRuntimeExports.jsx(PreviewOpen,{})}),jsxRuntimeExports.jsx("div",{className:"group-operator",onClick:this.toggleLock,children:o?jsxRuntimeExports.jsx(Lock,{}):jsxRuntimeExports.jsx(Unlock,{})})]})]}),n&&jsxRuntimeExports.jsx("div",{className:"group-content",children:e})]})}}class RuntimeStore{constructor(){i(this,"auxiliaryBorder",!1);i(this,"setAuxiliaryBorder",e=>{this.auxiliaryBorder=e});makeObservable(this,{auxiliaryBorder:observable,setAuxiliaryBorder:action})}}const runtimeConfigStore=new RuntimeStore;class BPExecutor{constructor(){i(this,"executeCount",0)}static triggerComponentEvent(e,s,o){const n=e+":"+s+":"+AnchorPointType.OUTPUT,r=new BPExecutor;r.execute(n,r,o)}execute(e,s,o){if(s.executeCount>1e3){console.warn("蓝图单条路径执行次数超过1000，请检查是否出现死循环逻辑！");return}if(s.executeCount++,!e||e===""||e.split(":").length!==3)return;const{bpAPMap:r}=bluePrintManager,c=r[e];c&&c.forEach(a=>{const[l,h,d]=a.split(":"),{bpNodeControllerInsMap:x}=bluePrintManager,u=x[l];u&&u.execute({nodeId:l,apId:h,anchorType:parseInt(d)},s,o)})}}var m;class ComponentContainer extends React.PureComponent{constructor(){super(...arguments);i(this,"ref",null);i(this,"mode",((m=URLUtil.parseUrlParams())==null?void 0:m.mode)||DesignerMode.EDIT)}componentDidMount(){const{layer:s}=this.props,{elemConfigs:o,compController:n}=layerManager,r=DesignerLoaderFactory.getLoader(this.mode).definitionMap[s.type];if(r){const c=r.getController();if(c){let a;s.id in n?a=n[s.id].getConfig():s.id in o?a=o[s.id]:(a=r.getInitConfig(),a.base.id=s.id);const{mode:l}=URLUtil.parseUrlParams(),h=new c;l===DesignerMode.VIEW&&registerProxy(s.id,h),n[s.id+""]=h,h.create(this.ref,a).then(()=>{var d;l===DesignerMode.VIEW&&(h.registerEvent(),h.loadComponentData()),h.updateFilter((d=h.getConfig())==null?void 0:d.filter),delete o[s.id]})}}}render(){const{layer:s}=this.props,{auxiliaryBorder:o}=runtimeConfigStore,n=this.mode===DesignerMode.VIEW||layerManager.enableEvent;return jsxRuntimeExports.jsx(reactExports.Suspense,{fallback:jsxRuntimeExports.jsx(Loading,{}),children:jsxRuntimeExports.jsx("div",{id:s.id,"data-type":s.type,"data-lock":s.lock,"data-hide":s.hide,style:{width:s.width,height:s.height,transform:`translate(${s.x}px, ${s.y}px)`,position:"absolute",visibility:s.hide?"hidden":"visible",border:o?"1px solid #65eafc":"none"},className:"lc-comp-item",children:jsxRuntimeExports.jsx("div",{ref:r=>this.ref=r,style:{width:"100%",height:"100%",pointerEvents:n?"auto":"none",position:"relative"}})},s.id+"")})}}const registerProxy=(t,e)=>{e.create=new Proxy(e.create,{apply(s,o,n){const r=s.apply(o,n);return BPExecutor.triggerComponentEvent(t,"loaded",e.config),r}}),e.changeData=new Proxy(e.changeData,{apply(s,o,n){return BPExecutor.triggerComponentEvent(t,"dataChange",n[0]),s.apply(o,n)}})};class AbstractDesignerController extends AbstractController{constructor(){super(...arguments);i(this,"interval",null);i(this,"lastReqState",!0);i(this,"errMsgDom",null);i(this,"doApi",config=>{const{url,method,params,header,frequency=5,filter,autoFlush}=config,request=()=>{FetchUtil.doRequest(url,method,header,params).then(res=>{var e;let{code,data}=res;if(code===200){if(this.lastReqState||(this.lastReqState=!0,(e=this.errMsgDom)==null||e.remove(),this.errMsgDom=null),filter&&filter!==""){const func=eval(`(${filter})`);data=typeof func=="function"?func(data):data}this.changeData(data)}else this.lastReqState=!1,this.errMsgDom||(this.errMsgDom=document.createElement("div"),this.errMsgDom.classList.add("view-error-message"),this.errMsgDom.innerText="数据加载失败...",this.container.appendChild(this.errMsgDom))})};autoFlush?this.interval=setInterval(()=>request(),frequency*1e3):request()});i(this,"doDatabase",config=>{const{sql,targetDb,filter,frequency,autoFlush}=config,request=()=>{FetchUtil.post("/api/db/executor/execute",{id:targetDb,sql}).then(res=>{var e;let{data,code}=res;if(code===200){if(this.lastReqState||(this.lastReqState=!0,(e=this.errMsgDom)==null||e.remove(),this.errMsgDom=null),filter&&filter!==""){const func=eval(`(${filter})`);data=typeof func=="function"?func(data):data}this.changeData(data)}else this.lastReqState=!1,this.errMsgDom||(this.errMsgDom=document.createElement("div"),this.errMsgDom.classList.add("view-error-message"),this.errMsgDom.innerText="数据加载失败...",this.container.appendChild(this.errMsgDom))})};autoFlush?this.interval=setInterval(()=>request(),(frequency||5)*1e3):request()})}changeData(e){}registerEvent(){}loadComponentData(){const{data:e}=this.config;if(!e)return;const{sourceType:s}=e;switch(s){case"static":break;case"api":this.doApi(e==null?void 0:e.apiData);break;case"database":this.doDatabase(e==null?void 0:e.database);break}}updateTheme(e){}updateFilter(e){this.config&&this.config.filter&&(this.config.filter=e),this.container&&(e!=null&&e.enable?this.container.style.filter=`blur(${e.blur}px) brightness(${e.brightness}) contrast(${e.contrast}) opacity(${e.opacity}) saturate(${e.saturate}) hue-rotate(${e.hueRotate}deg)`:this.container.style.filter="none")}}class GroupLayerController extends AbstractDesignerController{constructor(e,s,o){super(),this.container=e,this.config=s,this.instance=o}async create(e,s){}getConfig(){return this.config}update(e,s){}show(){var e;(e=this.instance)==null||e.setState({load:!0})}hide(){var e;(e=this.instance)==null||e.setState({load:!1})}}const GroupLayerController$1=Object.freeze(Object.defineProperty({__proto__:null,default:GroupLayerController},Symbol.toStringTag,{value:"Module"}));class GroupLayer extends React.PureComponent{constructor(){super(...arguments);i(this,"groupLayerRef",null);i(this,"state",{load:!0})}componentDidMount(){const{layer:s}=this.props,{elemConfigs:o,compController:n}=layerManager,r=DesignerLoaderFactory.getLoader(DesignerMode.EDIT).definitionMap.group;let c;s.id in n?c=n[s.id].getConfig():s.id in o?c=o[s.id]:(c=r.getInitConfig(),c.base.id=s.id),n[s.id]=new GroupLayerController(this.groupLayerRef,c,this),delete o[s.id]}render(){const{load:s}=this.state;return jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:s&&jsxRuntimeExports.jsx("div",{className:"component-group",ref:o=>this.groupLayerRef=o,style:{position:"absolute"},children:this.props.children})})}}class LayerBuilder{constructor(){i(this,"parser",(e,s=1)=>{e=lodashExports.cloneDeep(e);let o=[];const{layerHeader:n}=layerManager,r=(a,l)=>{if(a){if(l.push(a),a.childHeader){let d=e[a.childHeader];r(d,l)}let h=a.next;for(;h;){const d=e[h];d!=null&&d.childHeader&&r(e[d.childHeader],l),d&&l.push(d),h=d==null?void 0:d.next}}};r(e[n],o),s===0&&(o=o.reverse());const c=[];for(const a of o)if(!(a!=null&&a.pid))c.push(a);else{const l=e[a.pid];l&&(l.children=l.children||[],l.children.push(a))}return c});i(this,"buildLayerList",e=>{const s=[];return this.parser(e,1).forEach(o=>{s.push(this.buildLayer(o))}),s});i(this,"buildLayer",e=>{const{type:s,children:o}=e,{targetIds:n}=eventOperateStore,{layerInstances:r}=layerListStore,c={key:e.id,name:e.name,lock:e.lock,hide:e.hide,compId:e.id,type:e.type,selected:n.includes(e.id)};if(s==="group"){const a=[];return o==null||o.forEach(l=>{a.push(this.buildLayer(l))}),jsxRuntimeExports.jsx(LayerGroupItem,{...c,ref:l=>r[e.id]=l,children:a})}else return jsxRuntimeExports.jsx(LayerItem,{...c,ref:a=>r[e.id]=a})});i(this,"order",1);i(this,"buildCanvasComponents",e=>{const s=[];return this.parser(e,0).forEach(o=>{s.push(this.buildComponents(o))}),this.order=1,s});i(this,"buildComponents",e=>{const{type:s,children:o}=e,{layerConfigs:n}=layerManager,r=n[e.id];if(r&&(r.order=this.order++),s==="group"){const c=[];return o==null||o.forEach(a=>{c.push(this.buildComponents(a))}),jsxRuntimeExports.jsx(GroupLayer,{layer:e,children:c},e.id)}else return jsxRuntimeExports.jsx(ComponentContainer,{layer:e},e.id)})}}const layerBuilder=new LayerBuilder;export{AbstractDesignerController as A,BPExecutor as B,GroupLayerController$1 as G,Lock as L,PreviewClose as P,Unlock as U,contextMenuStore as c,layerBuilder as l,runtimeConfigStore as r};
