var P=Object.defineProperty;var R=(l,t,e)=>t in l?P(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var r=(l,t,e)=>(R(l,typeof t!="symbol"?t+"":t,e),e);import{r as p,R as y,j as o,L as $}from"./index-2e9IcPy_.js";import{l as f,a as C,aV as k,aW as F,U as b,aQ as m,D as N,aX as j,aY as z,aO as H,e as O}from"./EventOperateStore-HyYK-r0h.js";import{m as I,a as x,b as v}from"./mobxreact.esm-AuwNKQbs.js";import{A as g,_ as h}from"./AntdIcon-ncNZqSjB.js";var A={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M508 624a112 112 0 00112-112c0-3.28-.15-6.53-.43-9.74L498.26 623.57c3.21.28 6.45.43 9.74.43zm370.72-458.44L836 122.88a8 8 0 00-11.31 0L715.37 232.23Q624.91 186 512 186q-288.3 0-430.2 300.3a60.3 60.3 0 000 51.5q56.7 119.43 136.55 191.45L112.56 835a8 8 0 000 11.31L155.25 889a8 8 0 0011.31 0l712.16-712.12a8 8 0 000-11.32zM332 512a176 176 0 01258.88-155.28l-48.62 48.62a112.08 112.08 0 00-140.92 140.92l-48.62 48.62A175.09 175.09 0 01332 512z"}},{tag:"path",attrs:{d:"M942.2 486.2Q889.4 375 816.51 304.85L672.37 449A176.08 176.08 0 01445 676.37L322.74 798.63Q407.82 838 512 838q288.3 0 430.2-300.3a60.29 60.29 0 000-51.5z"}}]},name:"eye-invisible",theme:"filled"};const T=A;var E=function(t,e){return p.createElement(g,h(h({},t),{},{ref:e,icon:T}))};E.displayName="EyeInvisibleFilled";const w=p.forwardRef(E);var Q={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 444H820V330.4c0-17.7-14.3-32-32-32H473L355.7 186.2a8.15 8.15 0 00-5.5-2.2H96c-17.7 0-32 14.3-32 32v592c0 17.7 14.3 32 32 32h698c13 0 24.8-7.9 29.7-20l134-332c1.5-3.8 2.3-7.9 2.3-12 0-17.7-14.3-32-32-32zm-180 0H238c-13 0-24.8 7.9-29.7 20L136 643.2V256h188.5l119.6 114.4H748V444z"}}]},name:"folder-open",theme:"filled"};const W=Q;var M=function(t,e){return p.createElement(g,h(h({},t),{},{ref:e,icon:W}))};M.displayName="FolderOpenFilled";const q=p.forwardRef(M);var G={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v68c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-68c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM540 701v53c0 4.4-3.6 8-8 8h-40c-4.4 0-8-3.6-8-8v-53a48.01 48.01 0 1156 0z"}}]},name:"unlock",theme:"filled"};const _=G;var D=function(t,e){return p.createElement(g,h(h({},t),{},{ref:e,icon:_}))};D.displayName="UnlockFilled";const S=p.forwardRef(D);var K={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M408 312h48c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8zm352 120V144c0-17.7-14.3-32-32-32H296c-17.7 0-32 14.3-32 32v288c-66.2 0-120 52.1-120 116v356c0 4.4 3.6 8 8 8h720c4.4 0 8-3.6 8-8V548c0-63.9-53.8-116-120-116zm-72 0H336V184h352v248zM568 312h48c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8z"}}]},name:"usb",theme:"filled"};const X=K;var U=function(t,e){return p.createElement(g,h(h({},t),{},{ref:e,icon:X}))};U.displayName="UsbFilled";const V=p.forwardRef(U);class Y{constructor(){r(this,"visible",!1);r(this,"position",[0,0]);r(this,"mouseDownTime",0);r(this,"mouseUpTime",0);r(this,"updateVisible",t=>this.visible=t);r(this,"setPosition",t=>this.position=t);r(this,"setMouseDownTime",t=>this.mouseDownTime=t);r(this,"setMouseUpTime",t=>this.mouseUpTime=t);I(this,{visible:x,position:x,updateVisible:v,setPosition:v})}}const J=new Y;class B extends y.PureComponent{constructor(e){super(e);r(this,"layerName","");r(this,"closeContextMenu",()=>{const{visible:e,updateVisible:s}=J;e&&s(!1)});r(this,"toggleLock",e=>{e.stopPropagation();const{lockChange:s}=f;s&&s(this.state.compId,!this.state.lock),this.closeContextMenu()});r(this,"toggleHide",e=>{e.stopPropagation();const{hideChange:s}=f;s&&s(this.state.compId,!this.state.hide),this.closeContextMenu()});r(this,"onSelected",e=>{const{hide:s,compId:i}=this.state;if(s)return;e.stopPropagation();const{selectedChange:n}=f;n&&n(i,e),this.closeContextMenu()});r(this,"openInput",e=>{e.stopPropagation();const{inputMode:s}=this.state;s||this.setState({inputMode:!0}),this.closeContextMenu()});r(this,"closeInput",()=>{const{inputMode:e,compId:s,name:i}=this.state;if(e&&i!==this.layerName){const{updateLayer:n,compController:a}=C;n([{id:s,name:this.layerName}],!1);const c=a[s];c&&c.update({base:{name:this.layerName}},{reRender:!1}),this.setState({inputMode:!1,name:this.layerName})}else this.setState({inputMode:!1})});r(this,"changeLayerName",e=>{this.layerName=e.target.value});this.state={...e},this.layerName=e.name||""}}class Z extends B{render(){const{name:t="",inputMode:e,lock:s=!1,hide:i=!1,selected:n=!1}=this.state||{};return o.jsxs("div",{className:`layer-item ${n?"layer-selected":i?"layer-hide":s?"layer-lock":""}`,onClick:this.onSelected,onDoubleClick:this.openInput,children:[o.jsx("div",{className:"layer-name",children:e?o.jsx("input",{type:"text",defaultValue:t,autoFocus:!0,onChange:this.changeLayerName,onKeyDown:a=>{a.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):t}),o.jsxs("div",{className:"layer-operators",children:[o.jsx("div",{className:"layer-operator",onClick:this.openInput,children:o.jsx(k,{})}),o.jsx("div",{className:"layer-operator",onClick:this.toggleHide,children:i?o.jsx(w,{}):o.jsx(F,{})}),o.jsx("div",{className:"layer-operator",onClick:this.toggleLock,children:s?o.jsx(V,{}):o.jsx(S,{})})]})]})}}class ee extends B{render(){const{children:t}=this.props,{hide:e,lock:s,showContent:i,selected:n,name:a,inputMode:c}=this.state;return o.jsxs("div",{className:"layer-group",children:[o.jsxs("div",{className:`group-header ${n?"layer-selected":e?"layer-hide":s?"layer-lock":""}`,onDoubleClick:this.openInput,onClick:d=>this.onSelected(d),children:[o.jsxs("div",{className:"group-left",children:[o.jsx("div",{className:"group-icon",onClick:()=>this.setState({showContent:!i}),children:o.jsx(q,{})}),o.jsx("div",{className:"group-name",children:c?o.jsx("input",{type:"text",defaultValue:a,autoFocus:!0,onChange:this.changeLayerName,onKeyDown:d=>{d.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):a})]}),o.jsxs("div",{className:"group-operators",children:[o.jsx("div",{className:"group-operator",onClick:this.openInput,children:o.jsx(k,{})}),o.jsx("div",{className:"group-operator",onClick:this.toggleHide,children:e?o.jsx(w,{}):o.jsx(F,{})}),o.jsx("div",{className:"group-operator",onClick:this.toggleLock,children:s?o.jsx(V,{}):o.jsx(S,{})})]})]}),i&&o.jsx("div",{className:"group-content",children:t})]})}}class te{constructor(){r(this,"auxiliaryBorder",!1);r(this,"setAuxiliaryBorder",t=>{this.auxiliaryBorder=t});I(this,{auxiliaryBorder:x,setAuxiliaryBorder:v})}}const se=new te;var L;class oe extends y.PureComponent{constructor(){super(...arguments);r(this,"ref",null);r(this,"mode",((L=b.parseUrlParams())==null?void 0:L.mode)||m.EDIT)}componentDidMount(){const{layer:e}=this.props,{elemConfigs:s,compController:i}=C;let n=N.getLoader().definitionMap[e.type];if(n){const a=n.getController();if(a){let c;e.id in i?c=i[e.id].getConfig():e.id in s?c=s[e.id]:(c=n.getInitConfig(),c.base.id=e.id);const{mode:d}=b.parseUrlParams(),u=new a;d===m.VIEW&&ie(e.id,u),u.create(this.ref,c).then(()=>{d===m.VIEW&&(u.registerEvent(),u.loadComponentData()),delete s[e.id]}),i[e.id+""]=u}}}render(){const{layer:e}=this.props,{auxiliaryBorder:s}=se;return o.jsx(p.Suspense,{fallback:o.jsx($,{}),children:o.jsx("div",{id:e.id,"data-type":e.type,"data-lock":e.lock,"data-hide":e.hide,style:{width:e.width,height:e.height,transform:`translate(${e.x}px, ${e.y}px)`,position:"absolute",display:e.hide?"none":"block",border:s?"1px solid #65eafc":"none"},className:"lc-comp-item",children:o.jsx("div",{ref:i=>this.ref=i,style:{width:"100%",height:"100%",pointerEvents:`${this.mode===m.VIEW?"auto":"none"}`,position:"relative"}})},e.id+"")})}}const ie=(l,t)=>{t.create=new Proxy(t.create,{apply(e,s,i){const n=e.apply(s,i);return j.triggerComponentEvent(l,"loaded",t.config),n}}),t.changeData=new Proxy(t.changeData,{apply(e,s,i){return j.triggerComponentEvent(l,"dataChange",i[0]),e.apply(s,i)}})};class ne extends y.PureComponent{constructor(){super(...arguments);r(this,"groupLayerRef",null)}componentDidMount(){const{layer:e}=this.props,{elemConfigs:s,compController:i}=C;let n=N.getLoader().definitionMap.group,a;e.id in i?a=i[e.id].getConfig():e.id in s?a=s[e.id]:(a=n.getInitConfig(),a.base.id=e.id),i[e.id]=new z(this.groupLayerRef,a,this),delete s[e.id]}render(){return o.jsx("div",{className:"component-group",ref:e=>this.groupLayerRef=e,style:{position:"absolute"},children:this.props.children})}}class ae{constructor(){r(this,"parser",(t,e=1)=>{t=H.cloneDeep(t);let s;e===1?s=Object.values(t).sort((n,a)=>a.order-n.order):s=Object.values(t).sort((n,a)=>n.order-a.order);const i=[];for(const n of s)if(!(n!=null&&n.pid))i.push(n);else{const a=t[n.pid];a&&(a.children=a.children||[],a.children.push(n))}return i});r(this,"buildLayerList",t=>{const e=[];return this.parser(t,1).forEach(s=>{e.push(this.buildLayer(s))}),e});r(this,"buildLayer",t=>{const{type:e,children:s}=t,{targetIds:i}=O,{layerInstances:n}=f;let a={key:t.id,name:t.name,lock:t.lock,hide:t.hide,compId:t.id,type:t.type,selected:i.includes(t.id)};if(e==="group"){const c=[];return s==null||s.forEach(d=>{c.push(this.buildLayer(d))}),o.jsx(ee,{...a,ref:d=>n[t.id]=d,children:c})}else return o.jsx(Z,{...a,ref:c=>n[t.id]=c})});r(this,"buildCanvasComponents",t=>{const e=[];return this.parser(t,0).forEach(s=>{e.push(this.buildComponents(s))}),e});r(this,"buildComponents",t=>{const{type:e,children:s}=t;if(e==="group"){const i=[];return s==null||s.forEach(n=>{i.push(this.buildComponents(n))}),o.jsx(ne,{layer:t,children:i},t.id)}else return o.jsx(oe,{layer:t},t.id)})}}const he=new ae;export{J as c,he as l,se as r};
