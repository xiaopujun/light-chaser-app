import{r as reactExports,j as jsxRuntimeExports}from"./index-DEH0txKw.js";import{aK as LCGUI,b0 as Base64Util}from"./ViewDesignerLoader-jgZQec8d.js";import{O as ObjectUtil}from"./Input-DrP1MErD.js";import{globalMessage}from"./GlobalMessage-CLP7Ukq2.js";import{F as FetchUtil}from"./FetchUtil-jeBypYyg.js";import"./mobxreact.esm-Bj-qJWps.js";import"./MainRouter-BwKsbEMB.js";import"./zoom-Dmac6z75.js";import"./asyncToGenerator-BId76fBH.js";import"./Compact-N6WowFFV.js";import"./useZIndex-_nF327DT.js";import"./pickAttrs-MPILqOrS.js";import"./index-C1P9Qb-Y.js";import"./button-BVsw3twu.js";import"./render-CtKaNIyG.js";import"./index-DZ9jMG-M.js";import"./Data-D9YYElFN.js";import"./collapse-BbEVqHco.js";import"./CheckBox-DstIPFex.js";import"./index-DW5GKhvh.js";import"./index-BlXPA9sS.js";import"./NumberInput-e2UHMUMZ.js";import"./Overflow-CpDWjRBD.js";function StaticDataConfig(c){const{data:s,controller:i}=c,r=reactExports.useRef(s),l=()=>{var e;if(typeof r.current=="string"){const t=ObjectUtil.stringToJsObj(r.current);t?(i.update({data:{staticData:t}},{reRender:!1}),i.changeData(t)):(e=globalMessage.messageApi)==null||e.error("格式错误，请检查")}},a={type:"grid",config:{gridGap:"10px"},children:[{type:"code-editor",config:{height:500},value:JSON.stringify(r.current,null,2)||""},{id:"doStaticSave",type:"button",config:{children:"保存并刷新数据"}}]},n=e=>{const{id:t,data:o}=e;t==="doStaticSave"?l():r.current=o};return jsxRuntimeExports.jsx(LCGUI,{schema:a,onFieldChange:n})}function ApiDataConfig(props){var c,s,i,r,l,a,n;const{data,controller}=props,dataRef=reactExports.useRef(ObjectUtil.merge({url:"",method:"get",header:{},params:{},autoFlush:!1,frequency:5,filter:void 0},data)),apiTestResRef=reactExports.useRef(""),[count,setCount]=reactExports.useState(0),schema={type:"grid",config:{gridGap:"10px"},children:[{key:"url",type:"input",label:"接口地址",value:((c=dataRef.current)==null?void 0:c.url)||""},{key:"method",label:"请求方式",type:"select",value:(s=dataRef.current)==null?void 0:s.method,config:{options:[{value:"get",label:"GET"},{value:"post",label:"POST"}]}},{type:"grid",label:"自动更新",config:{columns:8},children:[{key:"autoFlush",type:"checkbox",value:!!((i=dataRef.current)!=null&&i.autoFlush)},{key:"frequency",type:"number-input",config:{min:5,containerStyle:{gridColumn:"2/9"}},value:((r=dataRef.current)==null?void 0:r.frequency)||5}]},{type:"card-panel",label:"请求头",tip:"请求头信息，json格式",config:{contentStyle:{padding:0}},children:[{id:"header",key:"header",type:"code-editor",config:{height:100},value:JSON.stringify((l=dataRef.current)==null?void 0:l.header,null,2)||""}]},{type:"card-panel",tip:"请求参数，json格式",label:"请求参数",config:{contentStyle:{padding:0}},children:[{id:"params",key:"params",type:"code-editor",config:{height:100},value:JSON.stringify((a=dataRef.current)==null?void 0:a.params,null,2)||""}]},{type:"card-panel",label:"过滤器",config:{contentStyle:{padding:0}},children:[{key:"filter",type:"code-editor",config:{height:200,language:"javascript"},value:((n=dataRef.current)==null?void 0:n.filter)||`function filter(data){


	return data
}`}]},{type:"card-panel",label:"响应结果",config:{contentStyle:{padding:0}},children:[{id:"apiTestRes",type:"code-editor",config:{readonly:!0,height:160},reRender:!0,value:apiTestResRef.current}]},{type:"grid",children:[{id:"testAndSave",type:"button",config:{children:"测试接口并保存"}}]}]},validate=()=>{var e,t,o,u,f,p;if(!((e=dataRef.current)!=null&&e.url))return(t=globalMessage.messageApi)==null||t.error("接口地址不能为空"),!1;if(!((o=dataRef.current)!=null&&o.method))return(u=globalMessage.messageApi)==null||u.error("请求方式不能为空"),!1;if(typeof dataRef.current.header=="string"){const d=ObjectUtil.stringToJsObj(dataRef.current.header);if(d)dataRef.current.header=d;else return(f=globalMessage.messageApi)==null||f.error("请求头不符合json格式"),!1}if(typeof dataRef.current.params=="string"){const d=ObjectUtil.stringToJsObj(dataRef.current.params);if(d)dataRef.current.params=d;else return(p=globalMessage.messageApi)==null||p.error("请求参数不符合json格式"),!1}return!0},testAndSave=()=>{if(!validate())return;const{params,header,url,method,filter}=dataRef.current;FetchUtil.doRequest(url,method,header,params).then(res=>{var e;let{data}=res;const{code}=res;if(code===200){if(filter&&filter!==""){const func=eval(`(${filter})`);data=typeof func=="function"?func(data):data}apiTestResRef.current=JSON.stringify(data,null,2),controller.update({data:{apiData:dataRef.current,staticData:data}},{reRender:!1}),controller.changeData(data)}else apiTestResRef.current=JSON.stringify({msg:"请求错误"},null,2),controller.update({data:{apiData:dataRef.current}},{reRender:!1}),(e=globalMessage.messageApi)==null||e.warning("配置项已保存，但数据未成功刷新")}).finally(()=>{setCount(count+1)})},onFieldChange=e=>{const{reRender:t,id:o,dataFragment:u}=e;if(o==="testAndSave")testAndSave();else{if(o==="apiTestRes")return;dataRef.current=ObjectUtil.merge(dataRef.current,u)}t&&setCount(count+1)};return jsxRuntimeExports.jsx(LCGUI,{schema,onFieldChange})}function DatabaseDataConfig(props){var c,s,i,r,l;const{data,controller}=props,dataRef=reactExports.useRef(data),[dataSourceList,setDataSourceList]=reactExports.useState([]),[testRes,setTestRes]=reactExports.useState(null),[count,setCount]=reactExports.useState(0);reactExports.useEffect(()=>{FetchUtil.get("/api/datasource/list").then(a=>{var n;if(a.code===200){const e=a.data.map(t=>({label:t.name,value:t.id}));setDataSourceList(e)}else(n=globalMessage.messageApi)==null||n.error(a.msg)})},[]);const validate=()=>{var e,t,o;const{targetDb:a,sql:n}=dataRef.current;return a?n?n.trim().startsWith("select")?!0:((o=globalMessage.messageApi)==null||o.error("SQL语句必须以select开头"),!1):((t=globalMessage.messageApi)==null||t.error("请输入SQL语句"),!1):((e=globalMessage.messageApi)==null||e.error("请选择数据库"),!1)},testAndSave=()=>{if(!validate())return;const{targetDb,sql,filter}=dataRef.current;!sql||sql===""||FetchUtil.post("/api/db/executor/execute",{id:targetDb,sql:Base64Util.toBase64(sql)}).then(res=>{var a;let{data}=res;const{code,msg}=res;if(code===200){if(filter&&filter!==""){const func=eval(`(${filter})`);data=typeof func=="function"?func(data):data}setTestRes(JSON.stringify(data,null,2)),controller.update({data:{database:dataRef.current,staticData:data}}),controller.changeData(data)}else setTestRes(JSON.stringify({msg},null,2)),controller.update({data:{database:dataRef.current}},{reRender:!1}),(a=globalMessage.messageApi)==null||a.warning("配置项已保存，但数据未成功刷新 "+msg)})},onFieldChange=a=>{const{reRender:n,id:e,dataFragment:t}=a;e==="testAndSave"?testAndSave():dataRef.current=ObjectUtil.merge(dataRef.current,t),n&&setCount(count+1)},schema={type:"grid",config:{gridGap:"10px"},children:[{key:"targetDb",label:"数据库",type:"select",value:(c=dataRef.current)==null?void 0:c.targetDb,reRender:!0,config:{options:dataSourceList}},{type:"grid",label:"自动更新",config:{columns:8},children:[{key:"autoFlush",type:"checkbox",value:!!((s=dataRef.current)!=null&&s.autoFlush)},{key:"frequency",type:"number-input",config:{min:5,containerStyle:{gridColumn:"2/9"}},value:((i=dataRef.current)==null?void 0:i.frequency)||5}]},{type:"card-panel",label:"SQL语句",config:{contentStyle:{padding:0}},children:[{key:"sql",type:"code-editor",config:{height:160,language:"sql"},value:(r=dataRef.current)==null?void 0:r.sql}]},{type:"card-panel",label:"过滤器",config:{contentStyle:{padding:0}},children:[{key:"filter",type:"code-editor",config:{height:200,language:"javascript"},value:((l=dataRef.current)==null?void 0:l.filter)||`function filter(data){


	return data
}`}]},{id:"databaseTestRes",type:"card-panel",label:"响应结果",config:{contentStyle:{padding:0}},children:[{id:"databaseTestRes",type:"code-editor",config:{height:200,language:"json"},reRender:!0,value:testRes}]},{type:"grid",children:[{id:"testAndSave",type:"button",config:{children:"测试SQL并保存"}}]}]};return jsxRuntimeExports.jsx(LCGUI,{schema,onFieldChange})}const DataConfig=c=>{var e;const{controller:s}=c,i=(e=s.getConfig())==null?void 0:e.data,[r,l]=reactExports.useState(i.sourceType),a=t=>{const{data:o}=t;l(o),s.update({data:{sourceType:o}},{reRender:!1})},n={type:"grid",config:{gridGap:"10px"},children:[{key:"sourceType",label:"数据源",type:"select",reRender:!0,value:r||"static",config:{options:[{value:"static",label:"静态数据"},{value:"api",label:"接口(API)"},{value:"database",label:"数据库"}],containerStyle:{marginBottom:10}}}]};return jsxRuntimeExports.jsxs("div",{className:"data-config",children:[jsxRuntimeExports.jsx(LCGUI,{schema:n,onFieldChange:a}),r==="static"&&jsxRuntimeExports.jsx(StaticDataConfig,{controller:s,data:i.staticData}),r==="api"&&jsxRuntimeExports.jsx(ApiDataConfig,{controller:s,data:i.apiData}),r==="database"&&jsxRuntimeExports.jsx(DatabaseDataConfig,{controller:s,data:i.database})]})};export{DataConfig as default};
