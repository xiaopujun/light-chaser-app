var f=Object.defineProperty;var y=(h,r,t)=>r in h?f(h,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[r]=t;var l=(h,r,t)=>(y(h,typeof r!="symbol"?r+"":r,t),t);import{r as m,m as u,O as p,aq as C,ar as g,as as D,j as S,at as v}from"./index-7a3e149d.js";class T extends m.Component{constructor(t){var c,i,d,s,n,o;super(t);l(this,"schema",{});l(this,"dataConfig",{});l(this,"state",{renderCount:0});l(this,"dataSourcesChange",t=>{const{controller:a}=this.props;a.update({data:{dataSource:t}},{reRender:!1}),this.setState({dataSource:t})});l(this,"validate",()=>{var t,a,e;return(t=this.dataConfig.apiData)!=null&&t.url?(a=this.dataConfig.apiData)!=null&&a.method?(e=this.dataConfig.apiData)!=null&&e.header?this.dataConfig.apiData.params?!0:(u.error("请求参数不符合json格式"),!1):(u.error("请求头不符合json格式"),!1):(u.error("请求方式不能为空"),!1):(u.error("接口地址不能为空"),!1)});l(this,"testApi",()=>{var i,d;if(!this.validate())return;let{params:t,header:a}=this.dataConfig.apiData;a=a&&typeof a=="string"?p.stringToJsObj((i=this.dataConfig.apiData)==null?void 0:i.header):a,t=t&&typeof t=="string"?p.stringToJsObj((d=this.dataConfig.apiData)==null?void 0:d.params):t;const{url:e,method:c}=this.dataConfig.apiData;C.sendHttpRequest(e,c,a,t).then(s=>{this.schema.children[2].children[5].children[0].value=JSON.stringify(s,null,2),this.setState({renderCount:this.state.renderCount+1})}).catch(()=>{this.schema.children[2].children[5].children[0].value=JSON.stringify({msg:"请求错误"},null,2),console.log(this.schema),this.setState({renderCount:this.state.renderCount+1})})});l(this,"onFieldChange",t=>{const{schemaKeyPath:a,data:e,reRender:c,id:i,dataFragment:d}=t;if(this.dataConfig=p.merge(this.dataConfig,d),i==="doStaticSave"){const s=this.schema.children[1].children[0].value.replace(/'/g,'"').replace(/\s/g,""),n=JSON.parse(s),{controller:o}=this.props;o.update({data:{staticData:{data:n}}},{reRender:!0,operateType:g.DATA})}if(i==="doTest"&&this.testApi(),i==="doSave"){if(!this.validate())return;const{controller:s}=this.props,{params:n,header:o}=this.dataConfig.apiData;n&&typeof n=="string"&&(this.dataConfig.apiData.params=p.stringToJsObj(n)),o&&typeof o=="string"&&(this.dataConfig.apiData.header=p.stringToJsObj(o)),s.update({data:{apiData:this.dataConfig.apiData}},{reRender:!0,operateType:g.DATA})}D.updateSchema(this.schema,a,e),c&&this.setState({renderCount:this.state.renderCount+1})});const{controller:a}=t,e=a.getConfig().data;this.dataConfig=e,this.state={renderCount:0},this.schema={type:"grid",config:{gridGap:"10px"},children:[{key:"dataSource",label:"数据源",type:"select",reRender:!0,value:(e==null?void 0:e.dataSource)||"static",config:{options:[{value:"static",label:"静态数据"},{value:"api",label:"接口(API)"}]}},{key:"staticData",rules:"{dataSource} === 'static'",children:[{key:"data",type:"code-editor",config:{height:500},value:JSON.stringify((c=e==null?void 0:e.staticData)==null?void 0:c.data,null,2)||""},{id:"doStaticSave",type:"button",config:{children:"保存并刷新数据",style:{width:"100%"}}}]},{key:"apiData",rules:"{dataSource} === 'api'",children:[{key:"url",type:"input",label:"接口地址",value:((i=e==null?void 0:e.apiData)==null?void 0:i.url)||""},{key:"method",label:"请求方式",type:"select",value:((d=e==null?void 0:e.apiData)==null?void 0:d.method)||"get",config:{options:[{value:"get",label:"GET"},{value:"post",label:"POST"}]}},{key:"flashFrequency",label:"刷新频率",type:"input",config:{prefix:"每",type:"number",suffix:"秒",min:5},value:((s=e==null?void 0:e.apiData)==null?void 0:s.flashFrequency)||5},{type:"item-panel",label:"请求头",tip:"请求头信息，json格式",children:[{key:"header",type:"code-editor",config:{height:100},value:JSON.stringify((n=e==null?void 0:e.apiData)==null?void 0:n.header,null,2)||""}]},{type:"item-panel",tip:"请求参数，json格式",label:"请求参数",children:[{key:"params",type:"code-editor",config:{height:100},value:JSON.stringify((o=e==null?void 0:e.apiData)==null?void 0:o.params,null,2)||""}]},{type:"item-panel",label:"响应结果",children:[{type:"code-editor",reRender:!0,config:{readonly:!0,height:160},value:""}]},{type:"grid",config:{columns:2},children:[{id:"doTest",type:"button",config:{children:"测试接口",style:{width:"100%"}}},{id:"doSave",type:"button",config:{children:"保存",style:{width:"100%"}}}]}]}]}}render(){return S.jsx(v,{schema:this.schema,onFieldChange:this.onFieldChange})}}export{T as default};
