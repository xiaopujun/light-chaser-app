var P=Object.defineProperty;var z=(d,t,e)=>t in d?P(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var a=(d,t,e)=>(z(d,typeof t!="symbol"?t+"":t,e),e);import{r as p,b as C,j as i,L as R}from"./index-HCNf1S-V.js";import{h as x,l as f,U as j,a as g,D as k,aN as F,aO as $,e as A}from"./LayerManager-zhrKdHEt.js";import{m as E,a as y,b,l as O}from"./Dialog-SklbesEj.js";import{E as N,a as I}from"./EyeFilled-8Ru1C7bi.js";import{A as v,_ as m}from"./AntdIcon-ZsdTX9-8.js";var T={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M508 624a112 112 0 00112-112c0-3.28-.15-6.53-.43-9.74L498.26 623.57c3.21.28 6.45.43 9.74.43zm370.72-458.44L836 122.88a8 8 0 00-11.31 0L715.37 232.23Q624.91 186 512 186q-288.3 0-430.2 300.3a60.3 60.3 0 000 51.5q56.7 119.43 136.55 191.45L112.56 835a8 8 0 000 11.31L155.25 889a8 8 0 0011.31 0l712.16-712.12a8 8 0 000-11.32zM332 512a176 176 0 01258.88-155.28l-48.62 48.62a112.08 112.08 0 00-140.92 140.92l-48.62 48.62A175.09 175.09 0 01332 512z"}},{tag:"path",attrs:{d:"M942.2 486.2Q889.4 375 816.51 304.85L672.37 449A176.08 176.08 0 01445 676.37L322.74 798.63Q407.82 838 512 838q288.3 0 430.2-300.3a60.29 60.29 0 000-51.5z"}}]},name:"eye-invisible",theme:"filled"};const q=T;var w=function(t,e){return p.createElement(v,m(m({},t),{},{ref:e,icon:q}))};w.displayName="EyeInvisibleFilled";const M=p.forwardRef(w);var G={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 444H820V330.4c0-17.7-14.3-32-32-32H473L355.7 186.2a8.15 8.15 0 00-5.5-2.2H96c-17.7 0-32 14.3-32 32v592c0 17.7 14.3 32 32 32h698c13 0 24.8-7.9 29.7-20l134-332c1.5-3.8 2.3-7.9 2.3-12 0-17.7-14.3-32-32-32zm-180 0H238c-13 0-24.8 7.9-29.7 20L136 643.2V256h188.5l119.6 114.4H748V444z"}}]},name:"folder-open",theme:"filled"};const Q=G;var D=function(t,e){return p.createElement(v,m(m({},t),{},{ref:e,icon:Q}))};D.displayName="FolderOpenFilled";const W=p.forwardRef(D);var _={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v68c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-68c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM540 701v53c0 4.4-3.6 8-8 8h-40c-4.4 0-8-3.6-8-8v-53a48.01 48.01 0 1156 0z"}}]},name:"unlock",theme:"filled"};const K=_;var U=function(t,e){return p.createElement(v,m(m({},t),{},{ref:e,icon:K}))};U.displayName="UnlockFilled";const S=p.forwardRef(U);var J={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M408 312h48c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8zm352 120V144c0-17.7-14.3-32-32-32H296c-17.7 0-32 14.3-32 32v288c-66.2 0-120 52.1-120 116v356c0 4.4 3.6 8 8 8h720c4.4 0 8-3.6 8-8V548c0-63.9-53.8-116-120-116zm-72 0H336V184h352v248zM568 312h48c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8z"}}]},name:"usb",theme:"filled"};const X=J;var H=function(t,e){return p.createElement(v,m(m({},t),{},{ref:e,icon:X}))};H.displayName="UsbFilled";const B=p.forwardRef(H);class Y{constructor(){a(this,"visible",!1);a(this,"position",[0,0]);a(this,"mouseDownTime",0);a(this,"mouseUpTime",0);a(this,"updateVisible",t=>this.visible=t);a(this,"setPosition",t=>this.position=t);a(this,"setMouseDownTime",t=>this.mouseDownTime=t);a(this,"setMouseUpTime",t=>this.mouseUpTime=t);E(this,{visible:y,position:y,updateVisible:b,setPosition:b})}}const Z=new Y;class V extends C.PureComponent{constructor(e){super(e);a(this,"layerName","");a(this,"closeContextMenu",()=>{const{visible:e,updateVisible:s}=Z;e&&s(!1)});a(this,"toggleLock",e=>{e.stopPropagation();const{lockChange:s}=x;s&&s(this.state.compId,!this.state.lock),this.closeContextMenu()});a(this,"toggleHide",e=>{e.stopPropagation();const{hideChange:s}=x;s&&s(this.state.compId,!this.state.hide),this.closeContextMenu()});a(this,"onSelected",e=>{const{hide:s,compId:o}=this.state;if(s)return;e.stopPropagation();const{selectedChange:l}=x;l&&l(o,e),this.closeContextMenu()});a(this,"openInput",e=>{e.stopPropagation();const{inputMode:s}=this.state;s||this.setState({inputMode:!0}),this.closeContextMenu()});a(this,"closeInput",()=>{const{inputMode:e,compId:s,name:o}=this.state;if(e&&o!==this.layerName){const{updateLayer:l,compController:r}=f;l([{id:s,name:this.layerName}],!1);const n=r[s];n&&n.update({base:{name:this.layerName}},{reRender:!1}),this.setState({inputMode:!1,name:this.layerName})}else this.setState({inputMode:!1})});a(this,"changeLayerName",e=>{this.layerName=e.target.value});this.state={...e},this.layerName=e.name||""}}class ee extends V{render(){const{name:t="",inputMode:e,lock:s=!1,hide:o=!1,selected:l=!1}=this.state||{};return i.jsxs("div",{className:`layer-item ${l?"layer-selected":o?"layer-hide":s?"layer-lock":""}`,onClick:this.onSelected,onDoubleClick:this.openInput,children:[i.jsx("div",{className:"layer-name",children:e?i.jsx("input",{type:"text",defaultValue:t,autoFocus:!0,onChange:this.changeLayerName,ref:r=>r==null?void 0:r.select(),onKeyDown:r=>{r.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):t}),i.jsxs("div",{className:"layer-operators",children:[i.jsx("div",{className:"layer-operator",onClick:this.openInput,children:i.jsx(N,{})}),i.jsx("div",{className:"layer-operator",onClick:this.toggleHide,children:o?i.jsx(M,{}):i.jsx(I,{})}),i.jsx("div",{className:"layer-operator",onClick:this.toggleLock,children:s?i.jsx(B,{}):i.jsx(S,{})})]})]})}}class te extends V{render(){const{children:t}=this.props,{hide:e,lock:s,showContent:o,selected:l,name:r,inputMode:n}=this.state;return i.jsxs("div",{className:"layer-group",children:[i.jsxs("div",{className:`group-header ${l?"layer-selected":e?"layer-hide":s?"layer-lock":""}`,onDoubleClick:this.openInput,onClick:c=>this.onSelected(c),children:[i.jsxs("div",{className:"group-left",children:[i.jsx("div",{className:"group-icon",onClick:()=>this.setState({showContent:!o}),children:i.jsx(W,{})}),i.jsx("div",{className:"group-name",children:n?i.jsx("input",{type:"text",defaultValue:r,autoFocus:!0,onChange:this.changeLayerName,ref:c=>c==null?void 0:c.select(),onKeyDown:c=>{c.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):r})]}),i.jsxs("div",{className:"group-operators",children:[i.jsx("div",{className:"group-operator",onClick:this.openInput,children:i.jsx(N,{})}),i.jsx("div",{className:"group-operator",onClick:this.toggleHide,children:e?i.jsx(M,{}):i.jsx(I,{})}),i.jsx("div",{className:"group-operator",onClick:this.toggleLock,children:s?i.jsx(B,{}):i.jsx(S,{})})]})]}),o&&i.jsx("div",{className:"group-content",children:t})]})}}class se{constructor(){a(this,"auxiliaryBorder",!1);a(this,"setAuxiliaryBorder",t=>{this.auxiliaryBorder=t});E(this,{auxiliaryBorder:y,setAuxiliaryBorder:b})}}const ie=new se;var L;class oe extends C.PureComponent{constructor(){super(...arguments);a(this,"ref",null);a(this,"mode",((L=j.parseUrlParams())==null?void 0:L.mode)||g.EDIT)}componentDidMount(){const{layer:e}=this.props,{elemConfigs:s,compController:o}=f,l=k.getLoader(this.mode).definitionMap[e.type];if(l){const r=l.getController();if(r){let n;e.id in o?n=o[e.id].getConfig():e.id in s?n=s[e.id]:(n=l.getInitConfig(),n.base.id=e.id);const{mode:c}=j.parseUrlParams(),h=new r;c===g.VIEW&&ne(e.id,h),o[e.id+""]=h,h.create(this.ref,n).then(()=>{c===g.VIEW&&(h.registerEvent(),h.loadComponentData()),delete s[e.id]})}}}render(){const{layer:e}=this.props,{auxiliaryBorder:s}=ie,o=this.mode===g.VIEW||f.enableEvent;return i.jsx(p.Suspense,{fallback:i.jsx(R,{}),children:i.jsx("div",{id:e.id,"data-type":e.type,"data-lock":e.lock,"data-hide":e.hide,style:{width:e.width,height:e.height,transform:`translate(${e.x}px, ${e.y}px)`,position:"absolute",display:e.hide?"none":"block",border:s?"1px solid #65eafc":"none"},className:"lc-comp-item",children:i.jsx("div",{ref:l=>this.ref=l,style:{width:"100%",height:"100%",pointerEvents:o?"auto":"none",position:"relative"}})},e.id+"")})}}const ne=(d,t)=>{t.create=new Proxy(t.create,{apply(e,s,o){const l=e.apply(s,o);return F.triggerComponentEvent(d,"loaded",t.config),l}}),t.changeData=new Proxy(t.changeData,{apply(e,s,o){return F.triggerComponentEvent(d,"dataChange",o[0]),e.apply(s,o)}})};class ae extends C.PureComponent{constructor(){super(...arguments);a(this,"groupLayerRef",null);a(this,"state",{load:!0})}componentDidMount(){const{layer:e}=this.props,{elemConfigs:s,compController:o}=f,l=k.getLoader(g.EDIT).definitionMap.group;let r;e.id in o?r=o[e.id].getConfig():e.id in s?r=s[e.id]:(r=l.getInitConfig(),r.base.id=e.id),o[e.id]=new $(this.groupLayerRef,r,this),delete s[e.id]}render(){const{load:e}=this.state;return i.jsx(i.Fragment,{children:e&&i.jsx("div",{className:"component-group",ref:s=>this.groupLayerRef=s,style:{position:"absolute"},children:this.props.children})})}}class le{constructor(){a(this,"parser",(t,e=1)=>{t=O.cloneDeep(t);let s=[];const{layerHeader:o}=f,l=(n,c)=>{if(n){if(c.push(n),n.childHeader){let u=t[n.childHeader];l(u,c)}let h=n.next;for(;h;){const u=t[h];u.childHeader&&l(t[u.childHeader],c),c.push(u),h=u==null?void 0:u.next}}};l(t[o],s),e===0&&(s=s.reverse());const r=[];for(const n of s)if(!(n!=null&&n.pid))r.push(n);else{const c=t[n.pid];c&&(c.children=c.children||[],c.children.push(n))}return r});a(this,"buildLayerList",t=>{const e=[];return this.parser(t,1).forEach(s=>{e.push(this.buildLayer(s))}),e});a(this,"buildLayer",t=>{const{type:e,children:s}=t,{targetIds:o}=A,{layerInstances:l}=x,r={key:t.id,name:t.name,lock:t.lock,hide:t.hide,compId:t.id,type:t.type,selected:o.includes(t.id)};if(e==="group"){const n=[];return s==null||s.forEach(c=>{n.push(this.buildLayer(c))}),i.jsx(te,{...r,ref:c=>l[t.id]=c,children:n})}else return i.jsx(ee,{...r,ref:n=>l[t.id]=n})});a(this,"order",1);a(this,"buildCanvasComponents",t=>{const e=[];return this.parser(t,0).forEach(s=>{e.push(this.buildComponents(s))}),this.order=1,e});a(this,"buildComponents",t=>{const{type:e,children:s}=t,{layerConfigs:o}=f,l=o[t.id];if(l&&(l.order=this.order++),e==="group"){const r=[];return s==null||s.forEach(n=>{r.push(this.buildComponents(n))}),i.jsx(ae,{layer:t,children:r},t.id)}else return i.jsx(oe,{layer:t},t.id)})}}const me=new le;export{Z as c,me as l,ie as r};
