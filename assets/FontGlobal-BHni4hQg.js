var B=Object.defineProperty;var H=(e,t,i)=>t in e?B(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var c=(e,t,i)=>H(e,typeof t!="symbol"?t+"":t,i);import{b as h,j as s,r as u,L as S}from"./index-D6TBVxtY.js";import{j,r as U,l as g,aP as b,b as R,aQ as F,e as T}from"./ViewDesignerLoader-CNRtTEkR.js";import{m as M,a as y,b as v}from"./mobxreact.esm-JD4dsIZD.js";import{E as N,c as I,U as w,D as C,d as A,l as O}from"./NumberInput-Cmrm0tNn.js";import{I as x}from"./index-mp9x8JDr.js";const $=x("folder-close",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M5 8C5 6.89543 5.89543 6 7 6H19L24 12H41C42.1046 12 43 12.8954 43 14V40C43 41.1046 42.1046 42 41 42H7C5.89543 42 5 41.1046 5 40V8Z",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M43 22H5",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M5 16V28",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M43 16V28",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),G=x("folder-open",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M4 9V41L9 21H39.5V15C39.5 13.8954 38.6046 13 37.5 13H24L19 7H6C4.89543 7 4 7.89543 4 9Z",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M40 41L44 21H8.8125L4 41H40Z",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),z=x("lock",!1,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("rect",{x:"6",y:"22",width:"36",height:"22",rx:"2",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M14 22V14C14 8.47715 18.4772 4 24 4C29.5228 4 34 8.47715 34 14V22",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M24 30V36",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),D=x("preview-close",!1,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M6 16C6.63472 17.2193 7.59646 18.3504 8.82276 19.3554C12.261 22.1733 17.779 24 24 24C30.221 24 35.739 22.1733 39.1772 19.3554C40.4035 18.3504 41.3653 17.2193 42 16",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M28.9775 24L31.048 31.7274",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M37.3535 21.3536L43.0103 27.0104",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M5.00004 27.0103L10.6569 21.3534",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M16.9278 31.7276L18.9983 24.0001",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),V=x("unlock",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("rect",{x:"7",y:"22.0476",width:"34",height:"22",rx:"2",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M14 22V14.0047C13.9948 8.87022 17.9227 4.56718 23.0859 4.05117C28.249 3.53516 32.9673 6.97408 34 12.0059",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M24 30V36",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))});class Z{constructor(){c(this,"visible",!1);c(this,"position",[0,0]);c(this,"mouseDownTime",0);c(this,"mouseUpTime",0);c(this,"updateVisible",t=>this.visible=t);c(this,"setPosition",t=>this.position=t);c(this,"setMouseDownTime",t=>this.mouseDownTime=t);c(this,"setMouseUpTime",t=>this.mouseUpTime=t);M(this,{visible:y,position:y,updateVisible:v,setPosition:v})}}const K=new Z;class P extends h.PureComponent{constructor(i){super(i);c(this,"layerName","");c(this,"closeContextMenu",()=>{const{visible:i,updateVisible:o}=K;i&&o(!1)});c(this,"toggleLock",i=>{i.stopPropagation();const{lockChange:o}=j;o&&o(this.state.compId,!this.state.lock),this.closeContextMenu()});c(this,"toggleHide",i=>{i.stopPropagation();const{hideChange:o}=j;o&&o(this.state.compId,!this.state.hide),this.closeContextMenu()});c(this,"onSelected",i=>{const{hide:o,compId:r}=this.state;if(o)return;i.stopPropagation();const{selectedChange:l}=j;l&&l(r,i),this.closeContextMenu()});c(this,"openInput",i=>{i.stopPropagation();const{inputMode:o}=this.state;o||this.setState({inputMode:!0}),this.closeContextMenu()});c(this,"activeComponentConfig",()=>{const{compId:i}=this.state,{activeElem:o,activeConfig:r}=U,{layerConfigs:l}=g,n=l[i];i!==o.id&&r(i,n.type)});c(this,"closeInput",()=>{const{inputMode:i,compId:o,name:r}=this.state;if(i&&r!==this.layerName){const{updateLayer:l,compController:n}=g;l([{id:o,name:this.layerName}],!1);const a=n[o];a&&a.update({base:{name:this.layerName}},{reRender:!1}),this.setState({inputMode:!1,name:this.layerName})}else this.setState({inputMode:!1})});c(this,"changeLayerName",i=>{this.layerName=i.target.value});this.state={...i},this.layerName=i.name||""}}class Q extends P{render(){const{name:t="",inputMode:i,lock:o=!1,hide:r=!1,selected:l=!1}=this.state||{};return s.jsxs("div",{className:`layer-item ${l?"layer-selected":r?"layer-hide":o?"layer-lock":""}`,onClick:this.onSelected,onDoubleClick:this.activeComponentConfig,children:[s.jsx("div",{className:"layer-name",children:i?s.jsx("input",{type:"text",defaultValue:t,autoFocus:!0,onChange:this.changeLayerName,ref:n=>n==null?void 0:n.select(),onKeyDown:n=>{n.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):t}),s.jsxs("div",{className:"layer-operators",children:[s.jsx("div",{className:"layer-operator",onClick:this.openInput,children:s.jsx(N,{size:14})}),s.jsx("div",{className:"layer-operator",onClick:this.toggleHide,children:r?s.jsx(D,{size:14}):s.jsx(I,{size:14})}),s.jsx("div",{className:"layer-operator",onClick:this.toggleLock,children:o?s.jsx(z,{size:14}):s.jsx(V,{size:14})})]})]})}}class _ extends P{render(){const{children:t}=this.props,{hide:i,lock:o,showContent:r,selected:l,name:n,inputMode:a}=this.state;return s.jsxs("div",{className:"layer-group",children:[s.jsxs("div",{className:`group-header ${l?"layer-selected":i?"layer-hide":o?"layer-lock":""}`,onDoubleClick:this.activeComponentConfig,onClick:d=>this.onSelected(d),children:[s.jsxs("div",{className:"group-left",children:[s.jsx("div",{className:"group-icon",onClick:()=>this.setState({showContent:!r}),children:r?s.jsx(G,{size:14}):s.jsx($,{size:14})}),s.jsx("div",{className:"group-name",children:a?s.jsx("input",{type:"text",defaultValue:n,autoFocus:!0,onChange:this.changeLayerName,ref:d=>d==null?void 0:d.select(),onKeyDown:d=>{d.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):n})]}),s.jsxs("div",{className:"group-operators",children:[s.jsx("div",{className:"group-operator",onClick:this.openInput,children:s.jsx(N,{size:14})}),s.jsx("div",{className:"group-operator",onClick:this.toggleHide,children:i?s.jsx(D,{size:14}):s.jsx(I,{size:14})}),s.jsx("div",{className:"group-operator",onClick:this.toggleLock,children:o?s.jsx(z,{size:14}):s.jsx(V,{size:14})})]})]}),r&&s.jsx("div",{className:"group-content",children:t})]})}}class q{constructor(){c(this,"auxiliaryBorder",!1);c(this,"setAuxiliaryBorder",t=>{this.auxiliaryBorder=t});M(this,{auxiliaryBorder:y,setAuxiliaryBorder:v})}}const J=new q,X=u.memo(e=>{var n;const{layer:t}=e,i=u.useRef(null),o=((n=w.parseUrlParams())==null?void 0:n.mode)||C.EDIT,{auxiliaryBorder:r}=J,l=o===C.VIEW||g.enableEvent;return u.useEffect(()=>{const{elemConfigs:a,compController:d}=g;A.getLoader(o).then(L=>{const k=L.definitionMap[t.type];if(k){const p=k.getController();if(p){let f;t.id in d?f=d[t.id].getConfig():t.id in a?f=a[t.id]:(f=k.getInitConfig(),f.base.id=t.id);const{mode:E}=w.parseUrlParams(),m=new p;E===C.VIEW&&Y(t.id,m),d[t.id+""]=m,m.create(i.current,f).then(()=>{var W;E===C.VIEW&&(m.registerEvent(),m.loadComponentData()),m.updateFilter((W=m.getConfig())==null?void 0:W.filter),delete a[t.id]})}}})},[]),s.jsx(u.Suspense,{fallback:s.jsx(S,{}),children:s.jsx("div",{id:t.id,"data-type":t.type,"data-lock":t.lock,"data-hide":t.hide,style:{width:t.width,height:t.height,transform:`translate(${t.x}px, ${t.y}px)`,position:"absolute",visibility:t.hide?"hidden":"visible",border:r?"1px solid #65eafc":"none"},className:"lc-comp-item",children:s.jsx("div",{ref:i,style:{width:"100%",height:"100%",pointerEvents:l?"auto":"none",position:"relative"}})},t.id+"")})}),Y=(e,t)=>{t.create=new Proxy(t.create,{apply(i,o,r){const l=i.apply(o,r);return b.triggerComponentEvent(e,"loaded",t.config),l}}),t.changeData=new Proxy(t.changeData,{apply(i,o,r){return b.triggerComponentEvent(e,"dataChange",r[0]),i.apply(o,r)}})};class ee extends h.PureComponent{constructor(){super(...arguments);c(this,"groupLayerRef",null);c(this,"state",{load:!0})}componentDidMount(){const{layer:i}=this.props,{elemConfigs:o,compController:r}=g,l=R.definitionMap.group;let n;i.id in r?n=r[i.id].getConfig():i.id in o?n=o[i.id]:(n=l.getInitConfig(),n.base.id=i.id),r[i.id]=new F(this.groupLayerRef,n,this),delete o[i.id]}render(){const{load:i}=this.state;return s.jsx(s.Fragment,{children:i&&s.jsx("div",{className:"component-group",ref:o=>this.groupLayerRef=o,style:{position:"absolute"},children:this.props.children})})}}class te{constructor(){c(this,"parser",(t,i=1)=>{t=O.cloneDeep(t);let o=[];const{layerHeader:r}=g,l=(a,d)=>{if(a){if(d.push(a),a.childHeader){let k=t[a.childHeader];l(k,d)}let L=a.next;for(;L;){const k=t[L];k!=null&&k.childHeader&&l(t[k.childHeader],d),k&&d.push(k),L=k==null?void 0:k.next}}};l(t[r],o),i===0&&(o=o.reverse());const n=[];for(const a of o)if(!(a!=null&&a.pid))n.push(a);else{const d=t[a.pid];d&&(d.children=d.children||[],d.children.push(a))}return n});c(this,"buildLayerList",t=>{const i=[];return this.parser(t,1).forEach(o=>{i.push(this.buildLayer(o))}),i});c(this,"buildLayer",t=>{const{type:i,children:o}=t,{targetIds:r}=T,{layerInstances:l}=j,n={name:t.name,lock:t.lock,hide:t.hide,compId:t.id,type:t.type,selected:r.includes(t.id)};if(i==="group"){const a=[];return o==null||o.forEach(d=>{a.push(this.buildLayer(d))}),u.createElement(_,{...n,key:t.id,ref:d=>l[t.id]=d},...a)}else return u.createElement(Q,{...n,key:t.id,ref:a=>l[t.id]=a})});c(this,"order",1);c(this,"buildCanvasComponents",t=>{const i=[];return this.parser(t,0).forEach(o=>{i.push(this.buildComponents(o))}),this.order=1,i});c(this,"buildComponents",t=>{const{type:i,children:o}=t,{layerConfigs:r}=g,l=r[t.id];if(l&&(l.order=this.order++),i==="group"){const n=[];return o==null||o.forEach(a=>{n.push(this.buildComponents(a))}),u.createElement(ee,{layer:t,key:t.id},...n)}else return u.createElement(X,{layer:t,key:t.id})})}}const ce=new te;export{z as L,D as P,V as U,K as c,ce as l,J as r};
