var U=Object.defineProperty;var O=(s,n,e)=>n in s?U(s,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[n]=e;var f=(s,n,e)=>O(s,typeof n!="symbol"?n+"":n,e);import{b as P,j as l,r as v,L as z}from"./index-DEH0txKw.js";import{C as h,n as b,B as H}from"./DesignerPage-BkqcmgXx.js";import{b7 as D,aE as d,b8 as F,b9 as X}from"./ViewDesignerLoader-jgZQec8d.js";import{f as Y}from"./Input-DrP1MErD.js";import{o as _}from"./mobxreact.esm-Bj-qJWps.js";import{D as G}from"./DragScaleProvider-BVoYYvU0.js";import{b as K}from"./BPRightStore-ChYhd--G.js";import"./FontGlobal-CoLoOZnJ.js";import"./PreviewOpen-nCi-AsB5.js";import"./index-DZ9jMG-M.js";import"./MainRouter-BwKsbEMB.js";import"./zoom-Dmac6z75.js";import"./asyncToGenerator-BId76fBH.js";import"./Compact-N6WowFFV.js";import"./useZIndex-_nF327DT.js";import"./System-BovEeRO9.js";import"./ThemeEditor-haCweeGM.js";import"./CheckBox-DstIPFex.js";import"./button-BVsw3twu.js";import"./render-CtKaNIyG.js";import"./index-C1P9Qb-Y.js";import"./GlobalMessage-CLP7Ukq2.js";import"./pickAttrs-MPILqOrS.js";import"./NumberInput-e2UHMUMZ.js";import"./FetchUtil-jeBypYyg.js";import"./Overflow-CpDWjRBD.js";import"./index-DW5GKhvh.js";import"./index-BlXPA9sS.js";import"./Info-C4-aD1yC.js";import"./Data-D9YYElFN.js";import"./collapse-BbEVqHco.js";class $ extends P.Component{constructor(){super(...arguments);f(this,"upLayer",null);f(this,"downLayer",null);f(this,"currentLine",{color:"#c0c0c0",lineWidth:1,lineDash:[10,10],startPoint:{x:0,y:0},endPoint:{x:0,y:0},firstCP:{x:0,y:0},secondCP:{x:0,y:0}});f(this,"keyDown",!1);f(this,"keyMove",!1);f(this,"bpMouseDown",e=>{const{target:r}=e;if(!r||!r.classList.contains("ap-circle"))return;const c=e.target,t=c.id.split(":");if(t&&t.length===3&&t[2]===D.INPUT.toString())return;const{canvasOffset:i}=d,{x:u,y:a,width:o,height:m}=c.getBoundingClientRect();this.currentLine.startPoint={x:u+o/2-i.x,y:a+m/2-i.y},this.currentLine.startAnchorId=c.id,this.keyDown=!0});f(this,"bpMouseUp",e=>{var S,E;const{nodeContainerRef:r,upCtx:c}=d,{width:t,height:i}=r==null?void 0:r.getBoundingClientRect(),u=e.target;if(!this.keyMove||!u||!u.classList.contains("ap-circle")||((S=u.id)==null?void 0:S.split(":")[2])!==D.INPUT.toString()){c==null||c.clearRect(0,0,t+10,i+10),this.keyDown=!1;return}const{canvasOffset:a}=d;this.keyMove=!1,this.keyDown=!1,d.upCtx.clearRect(0,0,t+10,i+10),this.currentLine.id=Y.generateId(),this.currentLine.lineDash=[],this.currentLine.lineWidth=1,this.currentLine.color="#a2a2a2",this.currentLine.endAnchorId=e.target.id;const{x:o,y:m,width:g,height:p}=(E=e.target)==null?void 0:E.getBoundingClientRect();this.currentLine.endPoint={x:o+g/2-a.x,y:m+p/2-a.y},h.drawBezierCurves(d.downCtx,[this.currentLine]);const{id:L,startPoint:C,endPoint:x,firstCP:y,secondCP:w,lineDash:R,startAnchorId:I,endAnchorId:N,color:k,lineWidth:B}=this.currentLine,A=h.sampleBezierCurve(C,y,w,x,20),{addAPMap:T,addLine:W,addAPLineMap:M}=d;W({id:L,color:k,lineWidth:B,lineDash:R,startPoint:{...C},endPoint:{...x},firstCP:{...y},secondCP:{...w},samplePoints:A,startAnchorId:I,endAnchorId:N}),T(this.currentLine.startAnchorId,this.currentLine.endAnchorId),M(this.currentLine.startAnchorId,this.currentLine.id),M(this.currentLine.endAnchorId,this.currentLine.id)});f(this,"bpMouseMove",e=>{if(!this.keyDown)return;this.keyMove=!0;const{startPoint:r,endPoint:c}=this.currentLine,{nodeContainerRef:t,canvasOffset:i}=d,{width:u,height:a}=t==null?void 0:t.getBoundingClientRect();this.currentLine.endPoint={x:e.clientX-i.x,y:e.clientY-i.y};const o=h.calculateControlPoint(r,c);this.currentLine.firstCP=o.firstCP,this.currentLine.secondCP=o.secondCP,d.upCtx.clearRect(0,0,u+10,a+10),h.drawBezierCurves(d.upCtx,[{color:"#c0c0c0",lineWidth:1,lineDash:[10,10],startPoint:this.currentLine.startPoint,endPoint:this.currentLine.endPoint,firstCP:this.currentLine.firstCP,secondCP:this.currentLine.secondCP}])})}componentDidMount(){const{setUpCtx:e,setDownCtx:r}=d;e(this.upLayer.getContext("2d")),r(this.downLayer.getContext("2d")),document.addEventListener("mousedown",this.bpMouseDown),document.addEventListener("mouseup",this.bpMouseUp),document.addEventListener("mousemove",this.bpMouseMove)}componentWillUnmount(){document.removeEventListener("mousedown",this.bpMouseDown),document.removeEventListener("mouseup",this.bpMouseUp),document.removeEventListener("mousemove",this.bpMouseMove)}render(){const e=window.innerWidth-670,r=window.innerHeight-85,c={position:"inherit",top:0,left:0};return l.jsxs("div",{style:{position:"absolute"},children:[l.jsx("canvas",{style:c,width:e,height:r,ref:t=>this.downLayer=t}),l.jsx("canvas",{style:c,width:e,height:r,ref:t=>this.upLayer=t})]})}}const q=s=>{const{children:n}=s,e=P.createRef();v.useEffect(()=>{const{setBpSelectRef:t}=d;t(e.current)});const r=t=>{const{bpMovableRef:i,selectedNodes:u}=d,a=t.inputEvent.target;(i.isMoveableElement(a)||u.some(o=>o===a||o.contains(a)))&&t.stop()},c=t=>{let{selected:i}=t;const{bpMovableRef:u,setSelectedNodes:a}=d;if(i=i.filter(o=>o.classList.contains("bp-node-container")),a(i),i.length!==0&&t.isDragStart){t.inputEvent.preventDefault();const o=setTimeout(()=>{u.dragStart(t.inputEvent),clearTimeout(o)})}};return l.jsxs(l.Fragment,{children:[n,l.jsx(F,{ref:e,dragContainer:".blue-print-canvas",selectableTargets:[".bp-node-container"],hitRate:0,ratio:0,selectByClick:!0,selectFromInside:!1,toggleContinueSelect:["ctrl"],onDragStart:r,onSelectEnd:c})]})},J=s=>{const{children:n}=s,e=P.useRef(null),r=P.useRef(null);return v.useEffect(()=>{const{setCanvasTranslate:c,setCanvasScale:t,setBpDragContentRef:i}=d,u=e.current,a=r.current;if(i(a),u&&a){const o=new G({container:u,content:a,dragCallback:m=>{const{position:g}=m;c(g),b()},dragEndCallback:()=>{h.updSegmentSamplingPoint()},scaleCallback:m=>{const{position:g,scale:p}=m;t(p),c(g),b(),h.updSegmentSamplingPoint()}});return()=>{o.destroy()}}},[]),l.jsx("div",{className:"bp-ds-container",id:"bp-ds-container",ref:e,style:{overflow:"hidden",width:"100%",height:"100%"},children:l.jsx("div",{ref:r,style:{width:0,height:0},children:n})})},Q=P.memo(({layout:s})=>{const n=v.useRef(null),e=t=>{const{setActiveNode:i}=K;i(t)};v.useEffect(()=>{const t=X.get(s.type);if(!t)return;const i=new t;if(!i)return;const{bpNodeControllerInsMap:u,bpNodeConfigMap:a}=d;let o=a[s.id];o||(o=i.getNodeInfo(s.id)),i.create(n.current,o),u[s.id]=i},[s.id,s.type]);const{position:r,id:c}=s;return l.jsx("div",{ref:n,className:"bp-node-container",id:`bpnode:${c}`,onDoubleClick:()=>e(c),style:{transform:"translate("+r.x+"px,"+r.y+"px)"}})}),V=_(()=>{const{bpNodeLayoutMap:s}=d,n=v.useRef(null);return v.useEffect(()=>{const{setNodeContainerRef:e}=d;e(n.current)},[]),l.jsx("div",{id:"bp-node-container",style:{position:"relative",width:"100%",height:"100%"},ref:n,children:l.jsx(q,{children:l.jsx(J,{children:l.jsx(H,{children:Object.values(s).map(e=>l.jsx(Q,{layout:e},e.id))})})})})}),j=s=>{const{clientX:n,clientY:e,shiftKey:r}=s,{selectedLines:c,setSelectedLines:t,downCtx:i}=d;if(c.length>0&&(c.forEach(p=>{p.lineWidth=1,p.color="#a2a2a2",b(),h.updSegmentSamplingPoint()}),t([])),!r)return;const{bpLines:u,canvasOffset:a}=d,o=[],m={x:n-a.x,y:e-a.y};if(Object.values(u).forEach(p=>{h.isMouseInRectangle(m,p.startPoint,p.endPoint)&&o.push(p)}),o.length===0)return;const g=[];for(let p=0;p<o.length;p++){const L=o[p],{samplePoints:C}=L;if(h.isMouseOnLine(m,C,5)){L.lineWidth=2,L.color="#d9d9d9",g.push(L),h.drawBezierCurves(i,[L]),h.updSegmentSamplingPoint();break}}t(g)},Ie=()=>(v.useEffect(()=>{const s=setTimeout(()=>{b(),h.updSegmentSamplingPoint(),clearTimeout(s)},50),{nodeContainerRef:n}=d;return n==null||n.addEventListener("click",j),()=>n==null?void 0:n.removeEventListener("click",j)},[]),l.jsx("div",{className:"blue-print-canvas",style:{overflow:"hidden",width:"100%",height:"100%"},children:l.jsxs(v.Suspense,{fallback:l.jsx(z,{}),children:[l.jsx($,{}),l.jsx(V,{})]})}));export{Ie as default};
