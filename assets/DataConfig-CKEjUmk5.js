import{r as reactExports,j as jsxRuntimeExports}from"./index-CRmipDYU.js";import{aL as LCGUI,b1 as Base64Util}from"./ViewDesignerLoader-2ZaNa5mi.js";import{O as ObjectUtil}from"./NumberInput-DwA_3ebS.js";import{globalMessage}from"./GlobalMessage-CFWlAJYU.js";import{F as FetchUtil}from"./FetchUtil-BuJzlMo4.js";import"./mobxreact.esm-Dn-2uaKK.js";import"./MainRouter-YUPEgR3T.js";import"./ContextIsolator-urbVMzjK.js";import"./asyncToGenerator-BFUSLXIu.js";import"./Compact-DviqQn_7.js";import"./pickAttrs-CXqQwhCc.js";import"./useZIndex-BpUNPx7g.js";import"./button--wGDZYGC.js";import"./render-UMYzhqKr.js";import"./index-Di7-uBEQ.js";import"./zoom-dHXOCKV3.js";import"./index-C0HpoK0x.js";import"./Data-DU404C66.js";import"./collapse-BbEVqHco.js";import"./index-FhfevFry.js";import"./index-BoLfqrWA.js";function StaticDataConfig(c){const{data:o,controller:i}=c,n=reactExports.useRef(o),l=()=>{var t;if(typeof n.current=="string"){const e=ObjectUtil.stringToJsObj(n.current);e?(i.update({data:{staticData:e}},{reRender:!1}),i.changeData(e)):(t=globalMessage.messageApi)==null||t.error("格式错误，请检查")}},a={type:"grid",config:{gridGap:"10px"},children:[{type:"code-editor",config:{height:500},value:JSON.stringify(n.current,null,2)||""},{id:"doStaticSave",type:"button",config:{children:"保存并刷新数据"}}]},s=t=>{const{id:e,data:r}=t;e==="doStaticSave"?l():n.current=r};return jsxRuntimeExports.jsx(LCGUI,{schema:a,onFieldChange:s})}function ApiDataConfig(props){var c,o,i,n,l,a,s;const{data,controller}=props,dataRef=reactExports.useRef(ObjectUtil.merge({url:"",method:"get",header:{},params:{},autoFlush:!1,frequency:5,filter:void 0},data)),apiTestResRef=reactExports.useRef(""),[count,setCount]=reactExports.useState(0),schema={type:"grid",config:{gridGap:"10px"},children:[{key:"url",type:"input",label:"接口地址",value:((c=dataRef.current)==null?void 0:c.url)||""},{key:"method",label:"请求方式",type:"select",value:(o=dataRef.current)==null?void 0:o.method,config:{options:[{value:"get",label:"GET"},{value:"post",label:"POST"}]}},{type:"grid",label:"自动更新",config:{columns:8},children:[{key:"autoFlush",type:"checkbox",value:!!((i=dataRef.current)!=null&&i.autoFlush)},{key:"frequency",type:"number-input",config:{min:5,containerStyle:{gridColumn:"2/9"}},value:((n=dataRef.current)==null?void 0:n.frequency)||5}]},{type:"card-panel",label:"请求头",tip:"请求头信息，json格式",config:{contentStyle:{padding:0}},children:[{id:"header",key:"header",type:"code-editor",config:{height:100},value:JSON.stringify((l=dataRef.current)==null?void 0:l.header,null,2)||""}]},{type:"card-panel",tip:"请求参数，json格式",label:"请求参数",config:{contentStyle:{padding:0}},children:[{id:"params",key:"params",type:"code-editor",config:{height:100},value:JSON.stringify((a=dataRef.current)==null?void 0:a.params,null,2)||""}]},{type:"card-panel",label:"过滤器",config:{contentStyle:{padding:0}},children:[{key:"filter",type:"code-editor",config:{height:200,language:"javascript"},value:((s=dataRef.current)==null?void 0:s.filter)||`function filter(data){


	return data
}`}]},{type:"card-panel",label:"响应结果",config:{contentStyle:{padding:0}},children:[{id:"apiTestRes",type:"code-editor",config:{readonly:!0,height:160},reRender:!0,value:apiTestResRef.current}]},{type:"grid",children:[{id:"testAndSave",type:"button",config:{children:"测试接口并保存"}}]}]},validate=()=>{var t,e,r,u,f,p;if(!((t=dataRef.current)!=null&&t.url))return(e=globalMessage.messageApi)==null||e.error("接口地址不能为空"),!1;if(!((r=dataRef.current)!=null&&r.method))return(u=globalMessage.messageApi)==null||u.error("请求方式不能为空"),!1;if(typeof dataRef.current.header=="string"){const d=ObjectUtil.stringToJsObj(dataRef.current.header);if(d)dataRef.current.header=d;else return(f=globalMessage.messageApi)==null||f.error("请求头不符合json格式"),!1}if(typeof dataRef.current.params=="string"){const d=ObjectUtil.stringToJsObj(dataRef.current.params);if(d)dataRef.current.params=d;else return(p=globalMessage.messageApi)==null||p.error("请求参数不符合json格式"),!1}return!0},testAndSave=()=>{if(!validate())return;const{params,header,url,method,filter}=dataRef.current;FetchUtil.doRequestNativeResult(url,method,header,params).then(res=>{var t;if(res){if(filter&&filter!==""){const func=eval(`(${filter})`);res=typeof func=="function"?func(res):res}apiTestResRef.current=JSON.stringify(res,null,2),controller.update({data:{apiData:dataRef.current,staticData:res}},{reRender:!1}),controller.changeData(res)}else apiTestResRef.current=JSON.stringify({msg:"请求错误"},null,2),controller.update({data:{apiData:dataRef.current}},{reRender:!1}),(t=globalMessage.messageApi)==null||t.warning("配置项已保存，但数据未成功刷新")}).finally(()=>{setCount(count+1)})},onFieldChange=t=>{const{reRender:e,id:r,dataFragment:u}=t;if(r==="testAndSave")testAndSave();else{if(r==="apiTestRes")return;dataRef.current=ObjectUtil.merge(dataRef.current,u)}e&&setCount(count+1)};return jsxRuntimeExports.jsx(LCGUI,{schema,onFieldChange})}function DatabaseDataConfig(props){var c,o,i,n,l;const{data,controller}=props,dataRef=reactExports.useRef(data),[dataSourceList,setDataSourceList]=reactExports.useState([]),[testRes,setTestRes]=reactExports.useState(null),[count,setCount]=reactExports.useState(0);reactExports.useEffect(()=>{FetchUtil.get("/api/datasource/list").then(a=>{var s;if(a.code===200){const t=a.data.map(e=>({label:e.name,value:e.id}));setDataSourceList(t)}else(s=globalMessage.messageApi)==null||s.error(a.msg)})},[]);const validate=()=>{var t,e,r;const{targetDb:a,sql:s}=dataRef.current;return a?s?s.trim().startsWith("select")?!0:((r=globalMessage.messageApi)==null||r.error("SQL语句必须以select开头"),!1):((e=globalMessage.messageApi)==null||e.error("请输入SQL语句"),!1):((t=globalMessage.messageApi)==null||t.error("请选择数据库"),!1)},testAndSave=()=>{if(!validate())return;const{targetDb,sql,filter}=dataRef.current;!sql||sql===""||FetchUtil.post("/api/db/executor/execute",{id:targetDb,sql:Base64Util.toBase64(sql)}).then(res=>{var a;let{data}=res;const{code,msg}=res;if(code===200){if(filter&&filter!==""){const func=eval(`(${filter})`);data=typeof func=="function"?func(data):data}setTestRes(JSON.stringify(data,null,2)),controller.update({data:{database:dataRef.current,staticData:data}}),controller.changeData(data)}else setTestRes(JSON.stringify({msg},null,2)),controller.update({data:{database:dataRef.current}},{reRender:!1}),(a=globalMessage.messageApi)==null||a.warning("配置项已保存，但数据未成功刷新 "+msg)})},onFieldChange=a=>{const{reRender:s,id:t,dataFragment:e}=a;t==="testAndSave"?testAndSave():dataRef.current=ObjectUtil.merge(dataRef.current,e),s&&setCount(count+1)},schema={type:"grid",config:{gridGap:"10px"},children:[{key:"targetDb",label:"数据库",type:"select",value:(c=dataRef.current)==null?void 0:c.targetDb,reRender:!0,config:{options:dataSourceList}},{type:"grid",label:"自动更新",config:{columns:8},children:[{key:"autoFlush",type:"checkbox",value:!!((o=dataRef.current)!=null&&o.autoFlush)},{key:"frequency",type:"number-input",config:{min:5,containerStyle:{gridColumn:"2/9"}},value:((i=dataRef.current)==null?void 0:i.frequency)||5}]},{type:"card-panel",label:"SQL语句",config:{contentStyle:{padding:0}},children:[{key:"sql",type:"code-editor",config:{height:160,language:"sql"},value:(n=dataRef.current)==null?void 0:n.sql}]},{type:"card-panel",label:"过滤器",config:{contentStyle:{padding:0}},children:[{key:"filter",type:"code-editor",config:{height:200,language:"javascript"},value:((l=dataRef.current)==null?void 0:l.filter)||`function filter(data){


	return data
}`}]},{id:"databaseTestRes",type:"card-panel",label:"响应结果",config:{contentStyle:{padding:0}},children:[{id:"databaseTestRes",type:"code-editor",config:{height:200,language:"json"},reRender:!0,value:testRes}]},{type:"grid",children:[{id:"testAndSave",type:"button",config:{children:"测试SQL并保存"}}]}]};return jsxRuntimeExports.jsx(LCGUI,{schema,onFieldChange})}const DataConfig=c=>{var t;const{controller:o}=c,i=(t=o.getConfig())==null?void 0:t.data,[n,l]=reactExports.useState(i.sourceType),a=e=>{const{data:r}=e;l(r),o.update({data:{sourceType:r}},{reRender:!1})},s={type:"grid",config:{gridGap:"10px"},children:[{key:"sourceType",label:"数据源",type:"select",reRender:!0,value:n||"static",config:{options:[{value:"static",label:"静态数据"},{value:"api",label:"接口(API)"},{value:"database",label:"数据库"}],containerStyle:{marginBottom:10}}}]};return reactExports.useEffect(()=>{const e=document.querySelector(".lc-config-panel");if(e){const r=new ResizeObserver(()=>{const u=document.querySelector(".data-config");if(!u)return;const f=window.getComputedStyle(u),p=u.clientWidth-parseFloat(f.paddingLeft)-parseFloat(f.paddingRight),d=e.getElementsByClassName("monaco-editor-container");if(d.length>0)for(let g=0;g<d.length;g++){const m=d[g];m&&(m.style.width=p+"px")}});return r.observe(e),()=>{r.unobserve(e),r.disconnect()}}},[]),jsxRuntimeExports.jsxs("div",{className:"data-config",children:[jsxRuntimeExports.jsx(LCGUI,{schema:s,onFieldChange:a}),n==="static"&&jsxRuntimeExports.jsx(StaticDataConfig,{controller:o,data:i.staticData}),n==="api"&&jsxRuntimeExports.jsx(ApiDataConfig,{controller:o,data:i.apiData}),n==="database"&&jsxRuntimeExports.jsx(DatabaseDataConfig,{controller:o,data:i.database})]})};export{DataConfig as default};
