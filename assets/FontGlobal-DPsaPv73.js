var S=Object.defineProperty;var U=(e,t,i)=>t in e?S(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var a=(e,t,i)=>U(e,typeof t!="symbol"?t+"":t,i);import{b as h,j as s,r as g,L as R}from"./index-Bt6dc0fX.js";import{k as j,r as F,l as u,aR as p,b as T,aS as O,e as A}from"./ViewDesignerLoader-D0E38GyN.js";import{m as I,a as v,b as E}from"./mobxreact.esm-CVpOJIJ4.js";import{E as V,d as z,U as y,D as C,e as _,c as $}from"./NumberInput-Drv0mbnr.js";import{I as x}from"./index-CVzf4nt6.js";const G=x("folder-close",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M5 8C5 6.89543 5.89543 6 7 6H19L24 12H41C42.1046 12 43 12.8954 43 14V40C43 41.1046 42.1046 42 41 42H7C5.89543 42 5 41.1046 5 40V8Z",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M43 22H5",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M5 16V28",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M43 16V28",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),Z=x("folder-open",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M4 9V41L9 21H39.5V15C39.5 13.8954 38.6046 13 37.5 13H24L19 7H6C4.89543 7 4 7.89543 4 9Z",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M40 41L44 21H8.8125L4 41H40Z",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),D=x("lock",!1,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("rect",{x:"6",y:"22",width:"36",height:"22",rx:"2",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M14 22V14C14 8.47715 18.4772 4 24 4C29.5228 4 34 8.47715 34 14V22",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M24 30V36",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),B=x("preview-close",!1,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M6 16C6.63472 17.2193 7.59646 18.3504 8.82276 19.3554C12.261 22.1733 17.779 24 24 24C30.221 24 35.739 22.1733 39.1772 19.3554C40.4035 18.3504 41.3653 17.2193 42 16",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M28.9775 24L31.048 31.7274",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M37.3535 21.3536L43.0103 27.0104",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M5.00004 27.0103L10.6569 21.3534",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M16.9278 31.7276L18.9983 24.0001",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),H=x("unlock",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("rect",{x:"7",y:"22.0476",width:"34",height:"22",rx:"2",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M14 22V14.0047C13.9948 8.87022 17.9227 4.56718 23.0859 4.05117C28.249 3.53516 32.9673 6.97408 34 12.0059",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M24 30V36",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))});class K{constructor(){a(this,"visible",!1);a(this,"position",[0,0]);a(this,"mouseDownTime",0);a(this,"mouseUpTime",0);a(this,"updateVisible",t=>this.visible=t);a(this,"setPosition",t=>this.position=t);a(this,"setMouseDownTime",t=>this.mouseDownTime=t);a(this,"setMouseUpTime",t=>this.mouseUpTime=t);I(this,{visible:v,position:v,updateVisible:E,setPosition:E})}}const q=new K;class P extends h.PureComponent{constructor(i){super(i);a(this,"layerName","");a(this,"closeContextMenu",()=>{const{visible:i,updateVisible:o}=q;i&&o(!1)});a(this,"toggleLock",i=>{i.stopPropagation();const{lockChange:o}=j;o&&o(this.state.compId,!this.state.lock),this.closeContextMenu()});a(this,"toggleHide",i=>{i.stopPropagation();const{hideChange:o}=j;o&&o(this.state.compId,!this.state.hide),this.closeContextMenu()});a(this,"onSelected",i=>{const{hide:o,compId:l}=this.state;if(o)return;i.stopPropagation();const{selectedChange:d}=j;d&&d(l,i),this.closeContextMenu()});a(this,"openInput",i=>{i.stopPropagation();const{inputMode:o}=this.state;o||this.setState({inputMode:!0}),this.closeContextMenu()});a(this,"activeComponentConfig",()=>{const{compId:i}=this.state,{activeElem:o,activeConfig:l}=F,{layerConfigs:d}=u,c=d[i];i!==o.id&&l(i,c.type)});a(this,"closeInput",()=>{const{inputMode:i,compId:o,name:l}=this.state;if(i&&l!==this.layerName){const{updateLayer:d,compController:c}=u;d([{id:o,name:this.layerName}],!1);const n=c[o];n&&n.update({base:{name:this.layerName}},{reRender:!1}),this.setState({inputMode:!1,name:this.layerName})}else this.setState({inputMode:!1})});a(this,"changeLayerName",i=>{this.layerName=i.target.value});this.state={...i},this.layerName=i.name||""}}class J extends P{render(){const{name:t="",inputMode:i,lock:o=!1,hide:l=!1,selected:d=!1}=this.state||{};return s.jsxs("div",{className:`layer-item ${d?"layer-selected":l?"layer-hide":o?"layer-lock":""}`,onClick:this.onSelected,onDoubleClick:this.activeComponentConfig,children:[s.jsx("div",{className:"layer-name",children:i?s.jsx("input",{type:"text",defaultValue:t,autoFocus:!0,onChange:this.changeLayerName,ref:c=>c==null?void 0:c.select(),onKeyDown:c=>{c.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):t}),s.jsxs("div",{className:"layer-operators",children:[s.jsx("div",{className:"layer-operator",onClick:this.openInput,children:s.jsx(V,{size:14})}),s.jsx("div",{className:"layer-operator",onClick:this.toggleHide,children:l?s.jsx(B,{size:14}):s.jsx(z,{size:14})}),s.jsx("div",{className:"layer-operator",onClick:this.toggleLock,children:o?s.jsx(D,{size:14}):s.jsx(H,{size:14})})]})]})}}class Q extends P{render(){const{children:t}=this.props,{hide:i,lock:o,showContent:l,selected:d,name:c,inputMode:n}=this.state;return s.jsxs("div",{className:"layer-group",children:[s.jsxs("div",{className:`group-header ${d?"layer-selected":i?"layer-hide":o?"layer-lock":""}`,onDoubleClick:this.activeComponentConfig,onClick:r=>this.onSelected(r),children:[s.jsxs("div",{className:"group-left",children:[s.jsx("div",{className:"group-icon",onClick:()=>this.setState({showContent:!l}),children:l?s.jsx(Z,{size:14}):s.jsx(G,{size:14})}),s.jsx("div",{className:"group-name",children:n?s.jsx("input",{type:"text",defaultValue:c,autoFocus:!0,onChange:this.changeLayerName,ref:r=>r==null?void 0:r.select(),onKeyDown:r=>{r.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):c})]}),s.jsxs("div",{className:"group-operators",children:[s.jsx("div",{className:"group-operator",onClick:this.openInput,children:s.jsx(V,{size:14})}),s.jsx("div",{className:"group-operator",onClick:this.toggleHide,children:i?s.jsx(B,{size:14}):s.jsx(z,{size:14})}),s.jsx("div",{className:"group-operator",onClick:this.toggleLock,children:o?s.jsx(D,{size:14}):s.jsx(H,{size:14})})]})]}),l&&s.jsx("div",{className:"group-content",children:t})]})}}class X{constructor(){a(this,"auxiliaryBorder",!1);a(this,"setAuxiliaryBorder",t=>{this.auxiliaryBorder=t});I(this,{auxiliaryBorder:v,setAuxiliaryBorder:E})}}const Y=new X,ee=g.memo(e=>{var c;const{layer:t}=e,i=g.useRef(null),o=((c=y.parseUrlParams())==null?void 0:c.mode)||C.EDIT,{auxiliaryBorder:l}=Y,d=o===C.VIEW||u.enableEvent;return g.useEffect(()=>{const{elemConfigs:n,compController:r}=u;_.getLoader(o).then(m=>{const k=m.definitionMap[t.type];if(k){const w=k.getController();if(w){let L;t.id in r?L=r[t.id].getConfig():t.id in n?L=n[t.id]:(L=k.getInitConfig(),L.base.id=t.id);const{mode:b}=y.parseUrlParams(),f=new w;b===C.VIEW&&te(t.id,f),r[t.id+""]=f,f.create(i.current,L).then(()=>{var W;b===C.VIEW&&(f.registerEvent(),f.loadComponentData(),++window.LC_ENV.createdController===window.LC_ENV.totalController&&u.compController&&Object.values(u.compController).forEach(N=>{var M;(M=p)==null||M.triggerComponentEvent(N.config.base.id,"loaded",N.config)})),f.updateFilter((W=f.getConfig())==null?void 0:W.filter),delete n[t.id]})}}})},[]),s.jsx(g.Suspense,{fallback:s.jsx(R,{}),children:s.jsx("div",{id:t.id,"data-type":t.type,"data-lock":t.lock,"data-hide":t.hide,style:{width:t.width,height:t.height,transform:`translate(${t.x}px, ${t.y}px)`,position:"absolute",visibility:t.hide?"hidden":"visible",border:l?"1px solid #65eafc":"none"},className:"lc-comp-item",children:s.jsx("div",{ref:i,style:{width:"100%",height:"100%",pointerEvents:d?"auto":"none",position:"relative"}})},t.id+"")})}),te=(e,t)=>{t.changeData=new Proxy(t.changeData,{apply(i,o,l){return p.triggerComponentEvent(e,"dataChange",l[0]),i.apply(o,l)}})};class ie extends h.PureComponent{constructor(){super(...arguments);a(this,"groupLayerRef",null);a(this,"state",{load:!0})}componentDidMount(){const{layer:i}=this.props,{elemConfigs:o,compController:l}=u,d=T.definitionMap.group,{mode:c}=y.parseUrlParams();let n;i.id in l?n=l[i.id].getConfig():i.id in o?n=o[i.id]:(n=d.getInitConfig(),n.base.id=i.id),l[i.id]=new O(this.groupLayerRef,n,this),delete o[i.id],c===C.VIEW&&++window.LC_ENV.createdController===window.LC_ENV.totalController&&u.compController&&Object.values(u.compController).forEach(r=>{var m;(m=p)==null||m.triggerComponentEvent(r.config.base.id,"loaded",r.config)})}render(){const{load:i}=this.state;return s.jsx(s.Fragment,{children:i&&s.jsx("div",{className:"component-group",ref:o=>this.groupLayerRef=o,style:{position:"absolute"},children:this.props.children})})}}class oe{constructor(){a(this,"parser",(t,i=1)=>{t=$(t);let o=[];const{layerHeader:l}=u,d=(n,r)=>{if(n){if(r.push(n),n.childHeader){let k=t[n.childHeader];d(k,r)}let m=n.next;for(;m;){const k=t[m];k!=null&&k.childHeader&&d(t[k.childHeader],r),k&&r.push(k),m=k==null?void 0:k.next}}};d(t[l],o),i===0&&(o=o.reverse());const c=[];for(const n of o)if(!(n!=null&&n.pid))c.push(n);else{const r=t[n.pid];r&&(r.children=r.children||[],r.children.push(n))}return c});a(this,"buildLayerList",t=>{const i=[];return this.parser(t,1).forEach(o=>{i.push(this.buildLayer(o))}),i});a(this,"buildLayer",t=>{const{type:i,children:o}=t,{targetIds:l}=A,{layerInstances:d}=j,c={name:t.name,lock:t.lock,hide:t.hide,compId:t.id,type:t.type,selected:l.includes(t.id)};if(i==="group"){const n=[];return o==null||o.forEach(r=>{n.push(this.buildLayer(r))}),g.createElement(Q,{...c,key:t.id,ref:r=>d[t.id]=r},...n)}else return g.createElement(J,{...c,key:t.id,ref:n=>d[t.id]=n})});a(this,"order",1);a(this,"buildCanvasComponents",t=>{const i=[];return this.parser(t,0).forEach(o=>{i.push(this.buildComponents(o))}),this.order=1,i});a(this,"buildComponents",t=>{const{type:i,children:o}=t,{layerConfigs:l}=u,d=l[t.id];if(d&&(d.order=this.order++),i==="group"){const c=[];return o==null||o.forEach(n=>{c.push(this.buildComponents(n))}),g.createElement(ie,{layer:t,key:t.id},...c)}else return g.createElement(ee,{layer:t,key:t.id})})}}const de=new oe;export{D as L,B as P,H as U,q as c,de as l,Y as r};
