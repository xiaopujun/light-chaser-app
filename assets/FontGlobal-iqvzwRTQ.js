var S=Object.defineProperty;var H=(e,t,i)=>t in e?S(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var a=(e,t,i)=>H(e,typeof t!="symbol"?t+"":t,i);import{b as h,j as s,r as k,L as U}from"./index-BGb4Vr6r.js";import{j,l as g,aP as W,b as z,aQ as R,e as T}from"./ViewDesignerLoader-DXeK7jRJ.js";import{m as M,a as p,b as y}from"./mobxreact.esm-DyjwGLY0.js";import{E as N,P as I}from"./PreviewOpen-C5YtI9Jz.js";import{I as C}from"./index-BB2N-NZK.js";import{U as w,D as x,a as F,l as A}from"./Input-D61RPOug.js";const $=C("folder-close",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M5 8C5 6.89543 5.89543 6 7 6H19L24 12H41C42.1046 12 43 12.8954 43 14V40C43 41.1046 42.1046 42 41 42H7C5.89543 42 5 41.1046 5 40V8Z",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M43 22H5",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M5 16V28",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M43 16V28",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),D=C("lock",!1,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("rect",{x:"6",y:"22",width:"36",height:"22",rx:"2",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M14 22V14C14 8.47715 18.4772 4 24 4C29.5228 4 34 8.47715 34 14V22",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M24 30V36",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),P=C("preview-close",!1,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M6 16C6.63472 17.2193 7.59646 18.3504 8.82276 19.3554C12.261 22.1733 17.779 24 24 24C30.221 24 35.739 22.1733 39.1772 19.3554C40.4035 18.3504 41.3653 17.2193 42 16",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M28.9775 24L31.048 31.7274",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M37.3535 21.3536L43.0103 27.0104",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M5.00004 27.0103L10.6569 21.3534",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M16.9278 31.7276L18.9983 24.0001",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),V=C("unlock",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("rect",{x:"7",y:"22.0476",width:"34",height:"22",rx:"2",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M14 22V14.0047C13.9948 8.87022 17.9227 4.56718 23.0859 4.05117C28.249 3.53516 32.9673 6.97408 34 12.0059",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M24 30V36",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))});class G{constructor(){a(this,"visible",!1);a(this,"position",[0,0]);a(this,"mouseDownTime",0);a(this,"mouseUpTime",0);a(this,"updateVisible",t=>this.visible=t);a(this,"setPosition",t=>this.position=t);a(this,"setMouseDownTime",t=>this.mouseDownTime=t);a(this,"setMouseUpTime",t=>this.mouseUpTime=t);M(this,{visible:p,position:p,updateVisible:y,setPosition:y})}}const O=new G;class B extends h.PureComponent{constructor(i){super(i);a(this,"layerName","");a(this,"closeContextMenu",()=>{const{visible:i,updateVisible:o}=O;i&&o(!1)});a(this,"toggleLock",i=>{i.stopPropagation();const{lockChange:o}=j;o&&o(this.state.compId,!this.state.lock),this.closeContextMenu()});a(this,"toggleHide",i=>{i.stopPropagation();const{hideChange:o}=j;o&&o(this.state.compId,!this.state.hide),this.closeContextMenu()});a(this,"onSelected",i=>{const{hide:o,compId:l}=this.state;if(o)return;i.stopPropagation();const{selectedChange:d}=j;d&&d(l,i),this.closeContextMenu()});a(this,"openInput",i=>{i.stopPropagation();const{inputMode:o}=this.state;o||this.setState({inputMode:!0}),this.closeContextMenu()});a(this,"closeInput",()=>{const{inputMode:i,compId:o,name:l}=this.state;if(i&&l!==this.layerName){const{updateLayer:d,compController:n}=g;d([{id:o,name:this.layerName}],!1);const r=n[o];r&&r.update({base:{name:this.layerName}},{reRender:!1}),this.setState({inputMode:!1,name:this.layerName})}else this.setState({inputMode:!1})});a(this,"changeLayerName",i=>{this.layerName=i.target.value});this.state={...i},this.layerName=i.name||""}}class K extends B{render(){const{name:t="",inputMode:i,lock:o=!1,hide:l=!1,selected:d=!1}=this.state||{};return s.jsxs("div",{className:`layer-item ${d?"layer-selected":l?"layer-hide":o?"layer-lock":""}`,onClick:this.onSelected,onDoubleClick:this.openInput,children:[s.jsx("div",{className:"layer-name",children:i?s.jsx("input",{type:"text",defaultValue:t,autoFocus:!0,onChange:this.changeLayerName,ref:n=>n==null?void 0:n.select(),onKeyDown:n=>{n.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):t}),s.jsxs("div",{className:"layer-operators",children:[s.jsx("div",{className:"layer-operator",onClick:this.openInput,children:s.jsx(N,{})}),s.jsx("div",{className:"layer-operator",onClick:this.toggleHide,children:l?s.jsx(P,{}):s.jsx(I,{})}),s.jsx("div",{className:"layer-operator",onClick:this.toggleLock,children:o?s.jsx(D,{}):s.jsx(V,{})})]})]})}}class Q extends B{render(){const{children:t}=this.props,{hide:i,lock:o,showContent:l,selected:d,name:n,inputMode:r}=this.state;return s.jsxs("div",{className:"layer-group",children:[s.jsxs("div",{className:`group-header ${d?"layer-selected":i?"layer-hide":o?"layer-lock":""}`,onDoubleClick:this.openInput,onClick:c=>this.onSelected(c),children:[s.jsxs("div",{className:"group-left",children:[s.jsx("div",{className:"group-icon",onClick:()=>this.setState({showContent:!l}),children:s.jsx($,{size:12})}),s.jsx("div",{className:"group-name",children:r?s.jsx("input",{type:"text",defaultValue:n,autoFocus:!0,onChange:this.changeLayerName,ref:c=>c==null?void 0:c.select(),onKeyDown:c=>{c.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):n})]}),s.jsxs("div",{className:"group-operators",children:[s.jsx("div",{className:"group-operator",onClick:this.openInput,children:s.jsx(N,{})}),s.jsx("div",{className:"group-operator",onClick:this.toggleHide,children:i?s.jsx(P,{}):s.jsx(I,{})}),s.jsx("div",{className:"group-operator",onClick:this.toggleLock,children:o?s.jsx(D,{}):s.jsx(V,{})})]})]}),l&&s.jsx("div",{className:"group-content",children:t})]})}}class Z{constructor(){a(this,"auxiliaryBorder",!1);a(this,"setAuxiliaryBorder",t=>{this.auxiliaryBorder=t});M(this,{auxiliaryBorder:p,setAuxiliaryBorder:y})}}const _=new Z,q=k.memo(e=>{var n;const{layer:t}=e,i=k.useRef(null),o=((n=w.parseUrlParams())==null?void 0:n.mode)||x.EDIT,{auxiliaryBorder:l}=_,d=o===x.VIEW||g.enableEvent;return k.useEffect(()=>{const{elemConfigs:r,compController:c}=g;F.getLoader(o).then(f=>{const u=f.definitionMap[t.type];if(u){const v=u.getController();if(v){let L;t.id in c?L=c[t.id].getConfig():t.id in r?L=r[t.id]:(L=u.getInitConfig(),L.base.id=t.id);const{mode:E}=w.parseUrlParams(),m=new v;E===x.VIEW&&J(t.id,m),c[t.id+""]=m,m.create(i.current,L).then(()=>{var b;E===x.VIEW&&(m.registerEvent(),m.loadComponentData()),m.updateFilter((b=m.getConfig())==null?void 0:b.filter),delete r[t.id]})}}})},[]),s.jsx(k.Suspense,{fallback:s.jsx(U,{}),children:s.jsx("div",{id:t.id,"data-type":t.type,"data-lock":t.lock,"data-hide":t.hide,style:{width:t.width,height:t.height,transform:`translate(${t.x}px, ${t.y}px)`,position:"absolute",visibility:t.hide?"hidden":"visible",border:l?"1px solid #65eafc":"none"},className:"lc-comp-item",children:s.jsx("div",{ref:i,style:{width:"100%",height:"100%",pointerEvents:d?"auto":"none",position:"relative"}})},t.id+"")})}),J=(e,t)=>{t.create=new Proxy(t.create,{apply(i,o,l){const d=i.apply(o,l);return W.triggerComponentEvent(e,"loaded",t.config),d}}),t.changeData=new Proxy(t.changeData,{apply(i,o,l){return W.triggerComponentEvent(e,"dataChange",l[0]),i.apply(o,l)}})};class X extends h.PureComponent{constructor(){super(...arguments);a(this,"groupLayerRef",null);a(this,"state",{load:!0})}componentDidMount(){const{layer:i}=this.props,{elemConfigs:o,compController:l}=g,d=z.definitionMap.group;let n;i.id in l?n=l[i.id].getConfig():i.id in o?n=o[i.id]:(n=d.getInitConfig(),n.base.id=i.id),l[i.id]=new R(this.groupLayerRef,n,this),delete o[i.id]}render(){const{load:i}=this.state;return s.jsx(s.Fragment,{children:i&&s.jsx("div",{className:"component-group",ref:o=>this.groupLayerRef=o,style:{position:"absolute"},children:this.props.children})})}}class Y{constructor(){a(this,"parser",(t,i=1)=>{t=A.cloneDeep(t);let o=[];const{layerHeader:l}=g,d=(r,c)=>{if(r){if(c.push(r),r.childHeader){let u=t[r.childHeader];d(u,c)}let f=r.next;for(;f;){const u=t[f];u!=null&&u.childHeader&&d(t[u.childHeader],c),u&&c.push(u),f=u==null?void 0:u.next}}};d(t[l],o),i===0&&(o=o.reverse());const n=[];for(const r of o)if(!(r!=null&&r.pid))n.push(r);else{const c=t[r.pid];c&&(c.children=c.children||[],c.children.push(r))}return n});a(this,"buildLayerList",t=>{const i=[];return this.parser(t,1).forEach(o=>{i.push(this.buildLayer(o))}),i});a(this,"buildLayer",t=>{const{type:i,children:o}=t,{targetIds:l}=T,{layerInstances:d}=j,n={name:t.name,lock:t.lock,hide:t.hide,compId:t.id,type:t.type,selected:l.includes(t.id)};if(i==="group"){const r=[];return o==null||o.forEach(c=>{r.push(this.buildLayer(c))}),k.createElement(Q,{...n,key:t.id,ref:c=>d[t.id]=c},...r)}else return k.createElement(K,{...n,key:t.id,ref:r=>d[t.id]=r})});a(this,"order",1);a(this,"buildCanvasComponents",t=>{const i=[];return this.parser(t,0).forEach(o=>{i.push(this.buildComponents(o))}),this.order=1,i});a(this,"buildComponents",t=>{const{type:i,children:o}=t,{layerConfigs:l}=g,d=l[t.id];if(d&&(d.order=this.order++),i==="group"){const n=[];return o==null||o.forEach(r=>{n.push(this.buildComponents(r))}),k.createElement(X,{layer:t,key:t.id},...n)}else return k.createElement(q,{layer:t,key:t.id})})}}const ae=new Y;export{D as L,P,V as U,O as c,ae as l,_ as r};
