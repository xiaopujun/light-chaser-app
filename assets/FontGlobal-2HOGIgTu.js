var D=Object.defineProperty;var P=(e,i,t)=>i in e?D(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t;var a=(e,i,t)=>(P(e,typeof i!="symbol"?i+"":i,t),t);import{b as h,j as s,r as V,L as B}from"./index-SMBBRqB_.js";import{j as L,l as m,U as p,a as g,D as v,aO as C,aP as S,e as H}from"./LayerManager-VL54_p8M.js";import{m as E,a as x,b as j,l as U}from"./LCGUI-jOMUoJmj.js";import{E as W,P as b}from"./PreviewOpen-i27gcALm.js";import{I as f}from"./index-sdBZGtOm.js";const z=f("folder-close",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M5 8C5 6.89543 5.89543 6 7 6H19L24 12H41C42.1046 12 43 12.8954 43 14V40C43 41.1046 42.1046 42 41 42H7C5.89543 42 5 41.1046 5 40V8Z",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M43 22H5",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M5 16V28",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M43 16V28",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),w=f("lock",!1,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("rect",{x:"6",y:"22",width:"36",height:"22",rx:"2",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M14 22V14C14 8.47715 18.4772 4 24 4C29.5228 4 34 8.47715 34 14V22",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M24 30V36",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),M=f("preview-close",!1,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("path",{d:"M6 16C6.63472 17.2193 7.59646 18.3504 8.82276 19.3554C12.261 22.1733 17.779 24 24 24C30.221 24 35.739 22.1733 39.1772 19.3554C40.4035 18.3504 41.3653 17.2193 42 16",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M28.9775 24L31.048 31.7274",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M37.3535 21.3536L43.0103 27.0104",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M5.00004 27.0103L10.6569 21.3534",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M16.9278 31.7276L18.9983 24.0001",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))}),N=f("unlock",!0,function(e){return h.createElement("svg",{width:e.size,height:e.size,viewBox:"0 0 48 48",fill:"none"},h.createElement("rect",{x:"7",y:"22.0476",width:"34",height:"22",rx:"2",fill:e.colors[1],stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M14 22V14.0047C13.9948 8.87022 17.9227 4.56718 23.0859 4.05117C28.249 3.53516 32.9673 6.97408 34 12.0059",stroke:e.colors[0],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}),h.createElement("path",{d:"M24 30V36",stroke:e.colors[2],strokeWidth:e.strokeWidth,strokeLinecap:e.strokeLinecap,strokeLinejoin:e.strokeLinejoin}))});class R{constructor(){a(this,"visible",!1);a(this,"position",[0,0]);a(this,"mouseDownTime",0);a(this,"mouseUpTime",0);a(this,"updateVisible",i=>this.visible=i);a(this,"setPosition",i=>this.position=i);a(this,"setMouseDownTime",i=>this.mouseDownTime=i);a(this,"setMouseUpTime",i=>this.mouseUpTime=i);E(this,{visible:x,position:x,updateVisible:j,setPosition:j})}}const T=new R;class I extends h.PureComponent{constructor(t){super(t);a(this,"layerName","");a(this,"closeContextMenu",()=>{const{visible:t,updateVisible:o}=T;t&&o(!1)});a(this,"toggleLock",t=>{t.stopPropagation();const{lockChange:o}=L;o&&o(this.state.compId,!this.state.lock),this.closeContextMenu()});a(this,"toggleHide",t=>{t.stopPropagation();const{hideChange:o}=L;o&&o(this.state.compId,!this.state.hide),this.closeContextMenu()});a(this,"onSelected",t=>{const{hide:o,compId:n}=this.state;if(o)return;t.stopPropagation();const{selectedChange:l}=L;l&&l(n,t),this.closeContextMenu()});a(this,"openInput",t=>{t.stopPropagation();const{inputMode:o}=this.state;o||this.setState({inputMode:!0}),this.closeContextMenu()});a(this,"closeInput",()=>{const{inputMode:t,compId:o,name:n}=this.state;if(t&&n!==this.layerName){const{updateLayer:l,compController:c}=m;l([{id:o,name:this.layerName}],!1);const r=c[o];r&&r.update({base:{name:this.layerName}},{reRender:!1}),this.setState({inputMode:!1,name:this.layerName})}else this.setState({inputMode:!1})});a(this,"changeLayerName",t=>{this.layerName=t.target.value});this.state={...t},this.layerName=t.name||""}}class A extends I{render(){const{name:i="",inputMode:t,lock:o=!1,hide:n=!1,selected:l=!1}=this.state||{};return s.jsxs("div",{className:`layer-item ${l?"layer-selected":n?"layer-hide":o?"layer-lock":""}`,onClick:this.onSelected,onDoubleClick:this.openInput,children:[s.jsx("div",{className:"layer-name",children:t?s.jsx("input",{type:"text",defaultValue:i,autoFocus:!0,onChange:this.changeLayerName,ref:c=>c==null?void 0:c.select(),onKeyDown:c=>{c.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):i}),s.jsxs("div",{className:"layer-operators",children:[s.jsx("div",{className:"layer-operator",onClick:this.openInput,children:s.jsx(W,{})}),s.jsx("div",{className:"layer-operator",onClick:this.toggleHide,children:n?s.jsx(M,{}):s.jsx(b,{})}),s.jsx("div",{className:"layer-operator",onClick:this.toggleLock,children:o?s.jsx(w,{}):s.jsx(N,{})})]})]})}}class F extends I{render(){const{children:i}=this.props,{hide:t,lock:o,showContent:n,selected:l,name:c,inputMode:r}=this.state;return s.jsxs("div",{className:"layer-group",children:[s.jsxs("div",{className:`group-header ${l?"layer-selected":t?"layer-hide":o?"layer-lock":""}`,onDoubleClick:this.openInput,onClick:d=>this.onSelected(d),children:[s.jsxs("div",{className:"group-left",children:[s.jsx("div",{className:"group-icon",onClick:()=>this.setState({showContent:!n}),children:s.jsx(z,{size:12})}),s.jsx("div",{className:"group-name",children:r?s.jsx("input",{type:"text",defaultValue:c,autoFocus:!0,onChange:this.changeLayerName,ref:d=>d==null?void 0:d.select(),onKeyDown:d=>{d.code==="Enter"&&this.closeInput()},onBlur:this.closeInput}):c})]}),s.jsxs("div",{className:"group-operators",children:[s.jsx("div",{className:"group-operator",onClick:this.openInput,children:s.jsx(W,{})}),s.jsx("div",{className:"group-operator",onClick:this.toggleHide,children:t?s.jsx(M,{}):s.jsx(b,{})}),s.jsx("div",{className:"group-operator",onClick:this.toggleLock,children:o?s.jsx(w,{}):s.jsx(N,{})})]})]}),n&&s.jsx("div",{className:"group-content",children:i})]})}}class O{constructor(){a(this,"auxiliaryBorder",!1);a(this,"setAuxiliaryBorder",i=>{this.auxiliaryBorder=i});E(this,{auxiliaryBorder:x,setAuxiliaryBorder:j})}}const $=new O;var y;class G extends h.PureComponent{constructor(){super(...arguments);a(this,"ref",null);a(this,"mode",((y=p.parseUrlParams())==null?void 0:y.mode)||g.EDIT)}componentDidMount(){const{layer:t}=this.props,{elemConfigs:o,compController:n}=m,l=v.getLoader(this.mode).definitionMap[t.type];if(l){const c=l.getController();if(c){let r;t.id in n?r=n[t.id].getConfig():t.id in o?r=o[t.id]:(r=l.getInitConfig(),r.base.id=t.id);const{mode:d}=p.parseUrlParams(),k=new c;d===g.VIEW&&K(t.id,k),n[t.id+""]=k,k.create(this.ref,r).then(()=>{d===g.VIEW&&(k.registerEvent(),k.loadComponentData()),delete o[t.id]})}}}render(){const{layer:t}=this.props,{auxiliaryBorder:o}=$,n=this.mode===g.VIEW||m.enableEvent;return s.jsx(V.Suspense,{fallback:s.jsx(B,{}),children:s.jsx("div",{id:t.id,"data-type":t.type,"data-lock":t.lock,"data-hide":t.hide,style:{width:t.width,height:t.height,transform:`translate(${t.x}px, ${t.y}px)`,position:"absolute",display:t.hide?"none":"block",border:o?"1px solid #65eafc":"none"},className:"lc-comp-item",children:s.jsx("div",{ref:l=>this.ref=l,style:{width:"100%",height:"100%",pointerEvents:n?"auto":"none",position:"relative"}})},t.id+"")})}}const K=(e,i)=>{i.create=new Proxy(i.create,{apply(t,o,n){const l=t.apply(o,n);return C.triggerComponentEvent(e,"loaded",i.config),l}}),i.changeData=new Proxy(i.changeData,{apply(t,o,n){return C.triggerComponentEvent(e,"dataChange",n[0]),t.apply(o,n)}})};class Z extends h.PureComponent{constructor(){super(...arguments);a(this,"groupLayerRef",null);a(this,"state",{load:!0})}componentDidMount(){const{layer:t}=this.props,{elemConfigs:o,compController:n}=m,l=v.getLoader(g.EDIT).definitionMap.group;let c;t.id in n?c=n[t.id].getConfig():t.id in o?c=o[t.id]:(c=l.getInitConfig(),c.base.id=t.id),n[t.id]=new S(this.groupLayerRef,c,this),delete o[t.id]}render(){const{load:t}=this.state;return s.jsx(s.Fragment,{children:t&&s.jsx("div",{className:"component-group",ref:o=>this.groupLayerRef=o,style:{position:"absolute"},children:this.props.children})})}}class _{constructor(){a(this,"parser",(i,t=1)=>{i=U.cloneDeep(i);let o=[];const{layerHeader:n}=m,l=(r,d)=>{if(r){if(d.push(r),r.childHeader){let u=i[r.childHeader];l(u,d)}let k=r.next;for(;k;){const u=i[k];u!=null&&u.childHeader&&l(i[u.childHeader],d),u&&d.push(u),k=u==null?void 0:u.next}}};l(i[n],o),t===0&&(o=o.reverse());const c=[];for(const r of o)if(!(r!=null&&r.pid))c.push(r);else{const d=i[r.pid];d&&(d.children=d.children||[],d.children.push(r))}return c});a(this,"buildLayerList",i=>{const t=[];return this.parser(i,1).forEach(o=>{t.push(this.buildLayer(o))}),t});a(this,"buildLayer",i=>{const{type:t,children:o}=i,{targetIds:n}=H,{layerInstances:l}=L,c={key:i.id,name:i.name,lock:i.lock,hide:i.hide,compId:i.id,type:i.type,selected:n.includes(i.id)};if(t==="group"){const r=[];return o==null||o.forEach(d=>{r.push(this.buildLayer(d))}),s.jsx(F,{...c,ref:d=>l[i.id]=d,children:r})}else return s.jsx(A,{...c,ref:r=>l[i.id]=r})});a(this,"order",1);a(this,"buildCanvasComponents",i=>{const t=[];return this.parser(i,0).forEach(o=>{t.push(this.buildComponents(o))}),this.order=1,t});a(this,"buildComponents",i=>{const{type:t,children:o}=i,{layerConfigs:n}=m,l=n[i.id];if(l&&(l.order=this.order++),t==="group"){const c=[];return o==null||o.forEach(r=>{c.push(this.buildComponents(r))}),s.jsx(Z,{layer:i,children:c},i.id)}else return s.jsx(G,{layer:i},i.id)})}}const te=new _;export{w as L,M as P,N as U,T as c,te as l,$ as r};
