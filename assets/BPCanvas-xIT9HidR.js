var U=Object.defineProperty;var O=(o,n,t)=>n in o?U(o,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[n]=t;var f=(o,n,t)=>(O(o,typeof n!="symbol"?n+"":n,t),t);import{b as P,j as l,r as v,L as z}from"./index-Duc4ZoM_.js";import{C as h,n as x,B as H}from"./DesignerPage-hOKeX8hE.js";import{aY as D,aB as d,aZ as Y,a_ as _}from"./ViewDesignerLoader-8rMP9FZs.js";import{I as F}from"./LocalOperator-t4oOcFvM.js";import{o as X}from"./mobxreact.esm-AXuQb6fD.js";import{D as G}from"./DragScaleProvider-Xr3oGa7d.js";import{b as K}from"./BPRightStore-swFcvk-U.js";import"./FontGlobal-IF-0qGeT.js";import"./PreviewOpen-xNkBcbY-.js";import"./index-AfMii643.js";import"./System-wlPeHLhg.js";import"./index-KGsAQAl1.js";import"./MainRouter-l7Z1Z1jr.js";import"./zoom-1qZDylxx.js";import"./Compact-BtIEhQqw.js";import"./AntdIcon-jwWmiLqW.js";import"./useZIndex-c7eQO3Zz.js";import"./Dialog-vSMHMWDI.js";import"./Grid-qWvRWUZo.js";import"./UIContainer-fqZbFePv.js";import"./Help-Q6DYu7mz.js";import"./Input-Fu5_43az.js";import"./MonacoEditor-AmRPsGTx.js";import"./Button-Tm3IfQtm.js";import"./Plus-WQxU0q_G.js";import"./render-8hUH_M6B.js";import"./pickAttrs-UI4Ho79H.js";import"./collapse-aS6vX33V.js";import"./fade-CRG4MrDV.js";import"./useForceUpdate-rXHM3SwU.js";import"./button-cD7Pe9UH.js";import"./omit-zfc2TTl_.js";import"./EyeOutlined-R3RbAP4C.js";import"./InfoCircleFilled-JfnNzh3b.js";import"./index-foMHq-FM.js";import"./ActionButton-AsinbvHa.js";import"./Info-kImE1q_J.js";import"./GlobalMessage-I0KrOayq.js";import"./index--SWnmJ5Q.js";import"./FetchUtil-5ZwtxN_0.js";import"./NumberInput-WrPaUvHm.js";import"./Select-wGR39UQA.js";import"./Radio-kbTZ0tv0.js";import"./ThemeEditor-2NmMzzG7.js";import"./ColorPicker-pyjWXEAx.js";import"./PurePanel-ruJ4o-iR.js";import"./index-tOmn1sxg.js";import"./Overflow-2V5ntg0K.js";import"./CardPanel-GnLi4EHp.js";import"./Data-_fslVRGK.js";class Z extends P.Component{constructor(){super(...arguments);f(this,"upLayer",null);f(this,"downLayer",null);f(this,"currentLine",{color:"#c0c0c0",lineWidth:1,lineDash:[10,10],startPoint:{x:0,y:0},endPoint:{x:0,y:0},firstCP:{x:0,y:0},secondCP:{x:0,y:0}});f(this,"keyDown",!1);f(this,"keyMove",!1);f(this,"bpMouseDown",t=>{const{target:s}=t;if(!s||!s.classList.contains("ap-circle"))return;const c=t.target,e=c.id.split(":");if(e&&e.length===3&&e[2]===D.INPUT.toString())return;const{canvasOffset:i}=d,{x:p,y:a,width:r,height:m}=c.getBoundingClientRect();this.currentLine.startPoint={x:p+r/2-i.x,y:a+m/2-i.y},this.currentLine.startAnchorId=c.id,this.keyDown=!0});f(this,"bpMouseUp",t=>{var S,E;const{nodeContainerRef:s,upCtx:c}=d,{width:e,height:i}=s==null?void 0:s.getBoundingClientRect(),p=t.target;if(!this.keyMove||!p||!p.classList.contains("ap-circle")||((S=p.id)==null?void 0:S.split(":")[2])!==D.INPUT.toString()){c==null||c.clearRect(0,0,e+10,i+10),this.keyDown=!1;return}const{canvasOffset:a}=d;this.keyMove=!1,this.keyDown=!1,d.upCtx.clearRect(0,0,e+10,i+10),this.currentLine.id=F.generateId(),this.currentLine.lineDash=[],this.currentLine.lineWidth=1,this.currentLine.color="#a2a2a2",this.currentLine.endAnchorId=t.target.id;const{x:r,y:m,width:g,height:u}=(E=t.target)==null?void 0:E.getBoundingClientRect();this.currentLine.endPoint={x:r+g/2-a.x,y:m+u/2-a.y},h.drawBezierCurves(d.downCtx,[this.currentLine]);const{id:L,startPoint:C,endPoint:b,firstCP:y,secondCP:w,lineDash:R,startAnchorId:I,endAnchorId:N,color:k,lineWidth:B}=this.currentLine,A=h.sampleBezierCurve(C,y,w,b,20),{addAPMap:T,addLine:W,addAPLineMap:M}=d;W({id:L,color:k,lineWidth:B,lineDash:R,startPoint:{...C},endPoint:{...b},firstCP:{...y},secondCP:{...w},samplePoints:A,startAnchorId:I,endAnchorId:N}),T(this.currentLine.startAnchorId,this.currentLine.endAnchorId),M(this.currentLine.startAnchorId,this.currentLine.id),M(this.currentLine.endAnchorId,this.currentLine.id)});f(this,"bpMouseMove",t=>{if(!this.keyDown)return;this.keyMove=!0;const{startPoint:s,endPoint:c}=this.currentLine,{nodeContainerRef:e,canvasOffset:i}=d,{width:p,height:a}=e==null?void 0:e.getBoundingClientRect();this.currentLine.endPoint={x:t.clientX-i.x,y:t.clientY-i.y};const r=h.calculateControlPoint(s,c);this.currentLine.firstCP=r.firstCP,this.currentLine.secondCP=r.secondCP,d.upCtx.clearRect(0,0,p+10,a+10),h.drawBezierCurves(d.upCtx,[{color:"#c0c0c0",lineWidth:1,lineDash:[10,10],startPoint:this.currentLine.startPoint,endPoint:this.currentLine.endPoint,firstCP:this.currentLine.firstCP,secondCP:this.currentLine.secondCP}])})}componentDidMount(){const{setUpCtx:t,setDownCtx:s}=d;t(this.upLayer.getContext("2d")),s(this.downLayer.getContext("2d")),document.addEventListener("mousedown",this.bpMouseDown),document.addEventListener("mouseup",this.bpMouseUp),document.addEventListener("mousemove",this.bpMouseMove)}componentWillUnmount(){document.removeEventListener("mousedown",this.bpMouseDown),document.removeEventListener("mouseup",this.bpMouseUp),document.removeEventListener("mousemove",this.bpMouseMove)}render(){const t=window.innerWidth-670,s=window.innerHeight-85,c={position:"inherit",top:0,left:0};return l.jsxs("div",{style:{position:"absolute"},children:[l.jsx("canvas",{style:c,width:t,height:s,ref:e=>this.downLayer=e}),l.jsx("canvas",{style:c,width:t,height:s,ref:e=>this.upLayer=e})]})}}const $=o=>{const{children:n}=o,t=P.createRef();v.useEffect(()=>{const{setBpSelectRef:e}=d;e(t.current)});const s=e=>{const{bpMovableRef:i,selectedNodes:p}=d,a=e.inputEvent.target;(i.isMoveableElement(a)||p.some(r=>r===a||r.contains(a)))&&e.stop()},c=e=>{let{selected:i}=e;const{bpMovableRef:p,setSelectedNodes:a}=d;if(i=i.filter(r=>r.classList.contains("bp-node-container")),a(i),i.length!==0&&e.isDragStart){e.inputEvent.preventDefault();const r=setTimeout(()=>{p.dragStart(e.inputEvent),clearTimeout(r)})}};return l.jsxs(l.Fragment,{children:[n,l.jsx(Y,{ref:t,dragContainer:".blue-print-canvas",selectableTargets:[".bp-node-container"],hitRate:0,ratio:0,selectByClick:!0,selectFromInside:!1,toggleContinueSelect:["ctrl"],onDragStart:s,onSelectEnd:c})]})},q=o=>{const{children:n}=o,t=P.useRef(null),s=P.useRef(null);return v.useEffect(()=>{const{setCanvasTranslate:c,setCanvasScale:e,setBpDragContentRef:i}=d,p=t.current,a=s.current;if(i(a),p&&a){const r=new G({container:p,content:a,dragCallback:m=>{const{position:g}=m;c(g),x()},dragEndCallback:()=>{h.updSegmentSamplingPoint()},scaleCallback:m=>{const{position:g,scale:u}=m;e(u),c(g),x(),h.updSegmentSamplingPoint()}});return()=>{r.destroy()}}},[]),l.jsx("div",{className:"bp-ds-container",id:"bp-ds-container",ref:t,style:{overflow:"hidden",width:"100%",height:"100%"},children:l.jsx("div",{ref:s,style:{width:0,height:0},children:n})})},J=P.memo(({layout:o})=>{const n=v.useRef(null),t=e=>{const{setActiveNode:i}=K;i(e)};v.useEffect(()=>{const e=_.get(o.type);if(!e)return;const i=new e;if(!i)return;const{bpNodeControllerInsMap:p,bpNodeConfigMap:a}=d;let r=a[o.id];r||(r=i.getNodeInfo(o.id)),i.create(n.current,r),p[o.id]=i},[o.id,o.type]);const{position:s,id:c}=o;return l.jsx("div",{ref:n,className:"bp-node-container",id:`bpnode:${c}`,onDoubleClick:()=>t(c),style:{transform:"translate("+s.x+"px,"+s.y+"px)"}})}),Q=X(()=>{const{bpNodeLayoutMap:o}=d,n=v.useRef(null);return v.useEffect(()=>{const{setNodeContainerRef:t}=d;t(n.current)},[]),l.jsx("div",{id:"bp-node-container",style:{position:"relative",width:"100%",height:"100%"},ref:n,children:l.jsx($,{children:l.jsx(q,{children:l.jsx(H,{children:Object.values(o).map(t=>l.jsx(J,{layout:t},t.id))})})})})}),j=o=>{const{clientX:n,clientY:t,shiftKey:s}=o,{selectedLines:c,setSelectedLines:e,downCtx:i}=d;if(c.length>0&&(c.forEach(u=>{u.lineWidth=1,u.color="#a2a2a2",x(),h.updSegmentSamplingPoint()}),e([])),!s)return;const{bpLines:p,canvasOffset:a}=d,r=[],m={x:n-a.x,y:t-a.y};if(Object.values(p).forEach(u=>{h.isMouseInRectangle(m,u.startPoint,u.endPoint)&&r.push(u)}),r.length===0)return;const g=[];for(let u=0;u<r.length;u++){const L=r[u],{samplePoints:C}=L;if(h.isMouseOnLine(m,C,5)){L.lineWidth=2,L.color="#d9d9d9",g.push(L),h.drawBezierCurves(i,[L]),h.updSegmentSamplingPoint();break}}e(g)},qt=()=>(v.useEffect(()=>{const o=setTimeout(()=>{x(),h.updSegmentSamplingPoint(),clearTimeout(o)},50),{nodeContainerRef:n}=d;return n==null||n.addEventListener("click",j),()=>n==null?void 0:n.removeEventListener("click",j)},[]),l.jsx("div",{className:"blue-print-canvas",style:{overflow:"hidden",width:"100%",height:"100%"},children:l.jsxs(v.Suspense,{fallback:l.jsx(z,{}),children:[l.jsx(Z,{}),l.jsx(Q,{})]})}));export{qt as default};
